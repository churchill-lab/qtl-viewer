<!DOCTYPE html>
<!--
This is a starter template page. Use this page to start your new project from
scratch. This page gets rid of all links and provides the needed markup only.
-->
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>QTL Viewer</title>
    <!-- Tell the browser to be responsive to screen width -->
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <!-- Bootstrap 3.3.6 -->
    <link rel="stylesheet" href="{{g.URL_BASE}}/static/AdminLTE-2.3.7/bootstrap/css/bootstrap.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">
    <!-- Ionicons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ionicons/2.0.1/css/ionicons.min.css">
    <!-- DataTables -->
    <link rel="stylesheet" href="{{g.URL_BASE}}/static/AdminLTE-2.3.7/plugins/datatables/dataTables.bootstrap.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="{{g.URL_BASE}}/static/AdminLTE-2.3.7/dist/css/AdminLTE.css">
    <!-- AdminLTE Skins. We have chosen the skin-blue for this starter
          page. However, you can choose any other skin. Make sure you
          apply the skin class to the body tag so the changes take effect.
    -->
    <link rel="stylesheet" href="{{g.URL_BASE}}/static/AdminLTE-2.3.7/dist/css/skins/skin-blue-light.css">
    <link rel="stylesheet" href="{{g.URL_BASE}}/static/bootstrap-select/css/bootstrap-select.min.css">
    <link rel="stylesheet" href="{{g.URL_BASE}}/static/bootstrap-multiselect/css/bootstrap-multiselect.css">

    <style>



.row .row-spacer {
	padding-top:10px;
}

        /*																																															/*
         * Row with equal height columns
         * --------------------------------------------------
         */
        .row-eq-height {
            display: -webkit-box;
            display: -webkit-flex;
            display: -ms-flexbox;
            display:         flex;
        }


        /* D3 style */
        #fact-svg-chart            .chart {
        }

        #fact-svg-chart            .plot-content text {
            font-family: 'Ubuntu', sans-serif;
        }

        #fact-svg-chart            .axis line, .axis path {
            shape-rendering: auto;
            stroke: black;
            fill: none;
        }

        #fact-svg-chart            .centered-checkbox {
            vertical-align: middle !important;
            margin: 0px !important;
            font-weight: normal;
        }

        #fact-svg-chart            #cursor-status {
            display: none;
            position: absolute;
            background-color: rgba(228, 255, 136, 0.3);
            pointer-events: none;
            white-space: nowrap;
        }

        #fact-svg-chart            #cursor-status td {
            border: 2px solid lightgrey;
        }

        #fact-svg-chart            .separator-line {
            stroke: lightgray;
        }

        #fact-svg-chart            .plot-title {
            font-size: x-large !important;
        }

        #fact-svg-chart            .axis-label {
            font-size: large !important;
        }

        #fact-svg-chart            .whiskers {
            stroke: black;
            stroke-width: 1px;
        }

        /*

        #fact-svg-chart            .data-point {
                        fill: rgba(70, 130, 180, 0.25);
                    }

        #fact-svg-chart            .circle-data-point {
                        fill:whitesmoke;
                        stroke: steelblue;
                          stroke-width: 1px;
                          r: 2px;
            shape-rendering: auto;

                    }
        */
        #fact-svg-chart .x-axis { font-family: 'Ubuntu', sans-serif; font-size: 10px; fill: black; font-weight:bold; }
        #fact-svg-chart .x-axis-label { font-family: 'Ubuntu', sans-serif; font-size: 16px; fill: black; font-weight:bold; }
        #fact-svg-chart .x-axis line { fill: none; stroke: black; shape-rendering: auto; }
        #fact-svg-chart .x.axis path { fill: none; stroke: none; shape-rendering: auto; }
        #fact-svg-chart .y-axis { font-family: 'Ubuntu', sans-serif; font-size: 10px; fill:black; font-weight:bold; }
        #fact-svg-chart .y-axis line { fill: none; stroke: white; shape-rendering: auto; }
        #fact-svg-chart .y-axis path { fill: none; stroke: none; shape-rendering: auto; }
        #fact-svg-chart .y-axis-label { font-family: 'Ubuntu', sans-serif; font-size: 16px; fill:black; font-weight:bold; }



        .female {
            fill: rgb(0,191,196);
            /*stroke: black;*/
            /*stroke-width: 1px;*/
        }
        .male {
            fill: rgb(248,118,109);
            /*stroke: black;*/
            /*stroke-width: 1px;*/
        }


        #fact-svg-chart	   .whiskers  {
            stroke-width: 3;
        }
    </style>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>
<!--
BODY TAG OPTIONS:
=================
Apply one or more of the following classes to get the
desired effect
|---------------------------------------------------------|
| SKINS         | skin-blue                               |
|               | skin-black                              |
|               | skin-purple                             |
|               | skin-yellow                             |
|               | skin-red                                |
|               | skin-green                              |
|---------------------------------------------------------|
|LAYOUT OPTIONS | fixed                                   |
|               | layout-boxed                            |
|               | layout-top-nav                          |
|               | sidebar-collapse                        |
|               | sidebar-mini                            |
|---------------------------------------------------------|
-->
<body class="hold-transition skin-blue-light layout-top-nav">
<div class="wrapper">
    <header class="main-header">
        <nav class="navbar navbar-static-top">
            <div class="container">
                <div class="navbar-header">
                    <a href="#" class="navbar-brand"><b>QTL</b> Viewer</a>
                    <!--
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse">
                        <i class="fa fa-bars"></i>
                    </button>
                    //-->
                </div>
            </div>
        </nav>
    </header>


    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">

        <!-- Content Header (Page header)
        <section class="content-header">
            <h1>
                QTL Viewer
                <small>Optional description</small>
            </h1>
            <ol class="breadcrumb">
                <li><a href="#"><i class="fa fa-dashboard"></i> Level</a></li>
                <li class="active">Here</li>
            </ol>
        </section>
        //-->

        <!-- Main content -->
        <section class="content">

            <div class="row">
                <div class="col-md-4">
                    <div class="row">
                        <div class="col-md-12">
                            <div id="search_box_div" class="box box-default">
                                <div class="box-header with-border">
                                    <h3 class="box-title"><i class="fa fa-search"></i> Search</h3>
                                    <div class="box-tools pull-right">
                                        <div class="btn-group" data-toggle="buttons">
                                            <label id="lbl_level_mrna" class="btn btn-sm btn-flat btn-primary active">
                                                <input type="radio" name="radio_level" id="radio_level" autocomplete="off" checked> mRNA
                                            </label>
                                            <label id="lbl_level_protein" class="btn btn-primary btn-sm btn-flat">
                                                <input type="radio" name="radio_level" id="radio_level" autocomplete="off"> Protein
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="box-body">
                                    <div class="nav-tabs-custom">
                                        <ul class="nav nav-tabs">
                                            <li class="active"><a href="#tab_1-1" data-toggle="tab">Search</a></li>
                                            <li><a href="#tab_2-2" data-toggle="tab">History</a></li>
                                        </ul>
                                    </div>
                                    <div class="tab-content">
                                        <div class="tab-pane active" id="tab_1-1">
                                            <div class="input-group">
                                                <input type="text" id="searchTerm" name="searchTerm" class="form-control" placeholder="">
                                                <span class="input-group-btn">
                                                    <button type="submit" name="search" id="btnGo" class="btn btn-flat btn-default"><i class="fa fa-search"></i></button>
                                                </span>
                                            </div>
                                            <div id="search_results_div"></div>
                                        </div>
                                        <!-- /.tab-pane -->
                                        <div class="tab-pane" id="tab_2-2">
                                            <div id="search_history_div" style="width:100%">
                                            </div>
                                        </div>
                                        <!-- /.tab-pane -->
                                    </div>
                                    <!-- /.tab-content -->
                                </div>
                                <!-- /.box-body -->
                            </div>
                            <!-- /.box -->
                        </div>
                        <!-- .col -->
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div id="profile_plot_container_div" class="box box-default hidden">
                                <div class="box-header with-border">
                                    <h3 class="box-title">Profile Plot</h3>
                                    <div class="box-tools pull-right">
                                    </div>
                                </div>
                                <!-- /.box-header -->
                                <div class="box-body">
                                    <div class="row">
                                        <div class="col-sm-8">
                                            <div id="factor-view-select-wrapper">
                                                <select id="factor-view-select" multiple="multiple">
                                                    <option value="age" order="1" selected>Age</option>
                                                    <option value="sex" order="2">Sex</option>
                                                    <option value="generation" order="3">Generation</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-sm-offset-1 col-sm-2">
                                            <button id="btnFactPlot" type="button" class="btn btn-sm btn-flat btn-primary">
                                                <span class="fa fa-refresh" aria-hidden="true"></span> Update</button>
                                        </div>
                                    </div>
                                    <div class="row row-spacer">
                                    </div>
                                    <div class="row row-spacer">
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-offset-1 col-sm-10">
                                            <div id="fact-svg-panel">
                                                <svg id="fact-svg-chart" width="100%" height="400px"></svg>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!--

                COLUMN 2

                //-->

                <div class="col-md-8">
                    <div class="row">
                        <div class="col-md-12">
                            <div id="gene_information_div" class="box box-default collapsed-box">
                                <div class="box-header with-border">
                                    <div id="div_current_gene_information_header">
                                        Please search for a gene of interest. 
                                    </div>
                                </div>
                                <div class="box-body">
                                    <div id="div_current_gene_information_body"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div id="lod_plot_container_div" class="box box-default hidden">
                                <div class="box-header with-border">
                                    <h3 class="box-title">LOD Plot</h3>
                                    <div class="box-tools pull-right">
                                        <!--
                                        <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i>
                                        </button>
                                        //-->
                                    </div>
                                </div>
                                <!-- /.box-header -->
                                <div id="plot_lod_box_body" class="box-body">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <strong>Scan Type</strong>
                                            <div class="btn-group" data-toggle="buttons">
                                                <label id="lbl_default" class="btn btn-xs btn-flat btn-default active">
                                                    <input type="radio" name="cond" id="cond_default" value="default" autocomplete="off" checked> Default
                                                </label>
                                                <label id="lbl_local" class="btn btn-xs btn-flat btn-default">
                                                    <input type="radio" name="cond" id="cond_local" value="local" autocomplete="off"> Local
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <div id="plot_lod" style="width: 100%"></div>
                                            <!--
                                            Plotly.relayout('plot_lod', {'width':$("#plot_lod").width()});
                                            //-->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div id="secondary_plot_container_div" class="nav-tabs-custom hidden">
                                <ul id="secondaryPlotTabs" class="nav nav-tabs">
                                    <li name="plot_effect" class="active"><a href="#tab_effect" data-toggle="tab">Effect Plot</a></li>
                                    <li name="plot_mediation"><a href="#tab_mediation" data-toggle="tab">Mediation Plot</a></li>
                                    <li class="pull-right"><a href="#" class="text-muted">Click on the LOD plot to generate the selected graph</a></li>
                                </ul>
                                <div class="tab-content">
                                    <div class="tab-pane active" id="tab_effect">
                                        <div class="row row-spacer"></div>
                                        <div class="row">
                                            <div class="col-sm-offset-1 col-sm-11" id="plot_effect_settings">
                                                <strong>Settings</strong>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-sm-offset-1 col-sm-11">
                                                 Best Linear Unbiased Predictors (BLUPs)
                                                <input id="mediate_blup" name="mediate_blup" type="checkbox" data-size="mini">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-sm-12">
                                                <div id="plot_effect">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- /.tab-pane -->
                                    <div class="tab-pane" id="tab_mediation">
                                        <div id="plot_mediation" style="width:100%; height:100%">
                                        </div>
                                    </div>
                                    <!-- /.tab-pane -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!-- /.content -->
    </div>
    <!-- /.content-wrapper -->

    <!-- Main Footer -->
    <footer class="main-footer">
        <!-- To the right -->
        <div class="pull-right hidden-xs">

        </div>
        <!-- Default to the left -->
        <strong>Created by <a href="http://churchill-lab.jax.org">The Churchill Lab</a>.</strong>
    </footer>

    <!-- Control Sidebar -->
    <aside class="control-sidebar control-sidebar-dark">
        <!-- Create the tabs -->
        <ul class="nav nav-tabs nav-justified control-sidebar-tabs">
            <li class="active"><a href="#control-sidebar-home-tab" data-toggle="tab"><i class="fa fa-home"></i></a></li>
            <li><a href="#control-sidebar-settings-tab" data-toggle="tab"><i class="fa fa-gears"></i></a></li>
        </ul>
        <!-- Tab panes -->
        <div class="tab-content">
            <!-- Home tab content -->
            <div class="tab-pane active" id="control-sidebar-home-tab">
                <h3 class="control-sidebar-heading">Recent Activity</h3>
                <ul class="control-sidebar-menu">
                    <li>
                        <a href="javascript::;">
                            <i class="menu-icon fa fa-birthday-cake bg-red"></i>

                            <div class="menu-info">
                                <h4 class="control-sidebar-subheading">Langdon's Birthday</h4>

                                <p>Will be 23 on April 24th</p>
                            </div>
                        </a>
                    </li>
                </ul>
                <!-- /.control-sidebar-menu -->

                <h3 class="control-sidebar-heading">Tasks Progress</h3>
                <ul class="control-sidebar-menu">
                    <li>
                        <a href="javascript::;">
                            <h4 class="control-sidebar-subheading">
                                Custom Template Design
                <span class="pull-right-container">
                  <span class="label label-danger pull-right">70%</span>
                </span>
                            </h4>

                            <div class="progress progress-xxs">
                                <div class="progress-bar progress-bar-danger" style="width: 70%"></div>
                            </div>
                        </a>
                    </li>
                </ul>
                <!-- /.control-sidebar-menu -->

            </div>
            <!-- /.tab-pane -->
            <!-- Stats tab content -->
            <div class="tab-pane" id="control-sidebar-stats-tab">Stats Tab Content</div>
            <!-- /.tab-pane -->
            <!-- Settings tab content -->
            <div class="tab-pane" id="control-sidebar-settings-tab">
                <form method="post">
                    <h3 class="control-sidebar-heading">General Settings</h3>

                    <div class="form-group">
                        <label class="control-sidebar-subheading">
                            Report panel usage
                            <input type="checkbox" class="pull-right" checked>
                        </label>

                        <p>
                            Some information about this general settings option
                        </p>
                    </div>
                    <!-- /.form-group -->
                </form>
            </div>
            <!-- /.tab-pane -->
        </div>
    </aside>
    <!-- /.control-sidebar -->
    <!-- Add the sidebar's background. This div must be placed
         immediately after the control sidebar -->
    <div class="control-sidebar-bg"></div>
</div>
<!-- ./wrapper -->



<div id="question" style="display:none; cursor: default">
    <h1>Generating graph...</h1>
    <input type="button" id="stopGenerating" value="Stop" />
</div>

<!-- REQUIRED JS SCRIPTS -->

<!-- jQuery 2.2.3 -->
<script src="{{g.URL_BASE}}/static/js/jquery-2.0.3.min.js"></script>
<!--
<script src="{{g.URL_BASE}}/static/AdminLTE-2.3.7/plugins/jQuery/jquery-2.2.3.min.js"></script>
//-->
<!-- Bootstrap 3.3.6 -->
<script src="{{g.URL_BASE}}/static/AdminLTE-2.3.7/bootstrap/js/bootstrap.min.js"></script>
<!-- AdminLTE App -->
<script src="{{g.URL_BASE}}/static/AdminLTE-2.3.7/dist/js/app.js"></script>
<!-- DataTables -->
<script src="{{g.URL_BASE}}/static/AdminLTE-2.3.7/plugins/datatables/jquery.dataTables.min.js"></script>
<script src="{{g.URL_BASE}}/static/AdminLTE-2.3.7/plugins/datatables/dataTables.bootstrap.min.js"></script>
<!-- SlimScroll -->
<script src="{{g.URL_BASE}}/static/AdminLTE-2.3.7/plugins/slimScroll/jquery.slimscroll.min.js"></script>
<!-- FastClick -->
<script src="{{g.URL_BASE}}/static/AdminLTE-2.3.7/plugins/fastclick/fastclick.js"></script>




<script src="http://localhost:9010/js/whoz_api.js"></script>
<script src="{{g.URL_BASE}}/static/js/jquery.blockUI.min.js"></script>
<script src="{{g.URL_BASE}}/static/js/plotly-latest.js"></script>

<!--
If using d3.v4.js, queue is incluced, however d3.v4.js breaks factexpviewer.js
//-->

<script src="{{g.URL_BASE}}/static/js/d3.v3.js"></script>
<script src="{{g.URL_BASE}}/static/js/d3-queue.min.js"></script>
<script src="{{g.URL_BASE}}/static/bootstrap-switch/js/bootstrap-switch.min.js"></script>
<script src="{{g.URL_BASE}}/static/bootstrap-select/js/bootstrap-select.min.js"></script>
<script src="{{g.URL_BASE}}/static/bootstrap-notify-3.1.3/bootstrap-notify.min.js"></script>
<script src="{{g.URL_BASE}}/static/bootstrap-multiselect/js/bootstrap-multiselect.js"></script>
<script src="{{g.URL_BASE}}/static/js/seedrandom.js"></script>
<script src="{{g.URL_BASE}}/static/js/factexpviewer.js"></script>
<script src="{{g.URL_BASE}}/static/js/js.cookie.js"></script>

<script>
    <!--
    // GLOBALS AND VARIABLES
    var _G = {};

    // information on chromosomes
    _G.chromosomes = {'idx': [], 'nameToIdx': {}, 'totalLength':-1};

    // gene ids
    /*
     gene_ids: {
     "ENSMUSG00000000001": {id:"ENSMUSG00000000001"},
     "ENSMUSG00000000008": {id:"ENSMUSG00000000008"}
     }
     */
    _G.genes = {gene_ids:{}};

    // protein ids and gene ids
    /*
     gene_ids: {
     "ENSMUSG00000000001": {
     id:"ENSMUSG00000000001",
     protein_ids:["ENSMUSP00000000001"]
     },
     "ENSMUSG00000000002": {
     id:"ENSMUSG00000000002",
     protein_ids:["ENSMUSP00000000049","ENSMUSP00000000050"]
     }
     },
     proteins_ids : [
     "ENSMUSP00000000001",
     "ENSMUSP00000000049",
     "ENSMUSP00000000090"
     ]
     */
    _G.proteins = {gene_ids:{}, proteins_ids: []};

    // gene id to search result map
    _G.searchResults = null;

    // this can be different from "_G.current_level"
    _G.searchResultsLevel = null;

    // APIS
    _G.api_root = "{{ CONF.API_R_BASE }}";
    _G.url_proxy = "{{ g.URL_BASE }}/proxy/";
    _G.url_chromosomes = "{{ g.URL_BASE }}/static/chromosomes.mm.38.NO_Y.json";

    _G.url_apis = {
        options: _G.api_root + '/options',
        ids: _G.api_root + '/ids',
        lod: _G.api_root + '/lodscan',
        mediate: _G.api_root + '/mediate',
        effect: _G.api_root + '/foundercoefs',
        expression: _G.api_root + '/expression',
        genes: 'http://churchill-lab.jax.org/whoz/api/id/',
    };

    // search/click history
    _G.historyTable = null;

    // PLOTS

    _G.plots = {
        lod: {
            el: 'plot_lod',
            obj: null,
        },
        mediation: {
            el: 'plot_mediation',
            obj: null,
        },
        effect: {
            el: 'plot_effect',
            obj: null,
        },
        profile: {
            el: 'plot_profile',
            obj: null,
        }
    };


    _G.current_gene = null;
    _G.current_gene_id = null;
    _G.current_protein_id = null;
    _G.current_level = "mrna";
    _G.cond = "default";





    var SPIN_GEARS = '<svg width="128px" height="128px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" class="uil-gears"><rect x="0" y="0" width="100" height="100" fill="none" class="bk"></rect><g transform="translate(-20,-20)"><path d="M79.9,52.6C80,51.8,80,50.9,80,50s0-1.8-0.1-2.6l-5.1-0.4c-0.3-2.4-0.9-4.6-1.8-6.7l4.2-2.9c-0.7-1.6-1.6-3.1-2.6-4.5 L70,35c-1.4-1.9-3.1-3.5-4.9-4.9l2.2-4.6c-1.4-1-2.9-1.9-4.5-2.6L59.8,27c-2.1-0.9-4.4-1.5-6.7-1.8l-0.4-5.1C51.8,20,50.9,20,50,20 s-1.8,0-2.6,0.1l-0.4,5.1c-2.4,0.3-4.6,0.9-6.7,1.8l-2.9-4.1c-1.6,0.7-3.1,1.6-4.5,2.6l2.1,4.6c-1.9,1.4-3.5,3.1-5,4.9l-4.5-2.1 c-1,1.4-1.9,2.9-2.6,4.5l4.1,2.9c-0.9,2.1-1.5,4.4-1.8,6.8l-5,0.4C20,48.2,20,49.1,20,50s0,1.8,0.1,2.6l5,0.4 c0.3,2.4,0.9,4.7,1.8,6.8l-4.1,2.9c0.7,1.6,1.6,3.1,2.6,4.5l4.5-2.1c1.4,1.9,3.1,3.5,5,4.9l-2.1,4.6c1.4,1,2.9,1.9,4.5,2.6l2.9-4.1 c2.1,0.9,4.4,1.5,6.7,1.8l0.4,5.1C48.2,80,49.1,80,50,80s1.8,0,2.6-0.1l0.4-5.1c2.3-0.3,4.6-0.9,6.7-1.8l2.9,4.2 c1.6-0.7,3.1-1.6,4.5-2.6L65,69.9c1.9-1.4,3.5-3,4.9-4.9l4.6,2.2c1-1.4,1.9-2.9,2.6-4.5L73,59.8c0.9-2.1,1.5-4.4,1.8-6.7L79.9,52.6 z M50,65c-8.3,0-15-6.7-15-15c0-8.3,6.7-15,15-15s15,6.7,15,15C65,58.3,58.3,65,50,65z" fill="#000000"><animateTransform attributeName="transform" type="rotate" from="90 50 50" to="0 50 50" dur="1s" repeatCount="indefinite"></animateTransform></path></g><g transform="translate(20,20) rotate(15 50 50)"><path d="M79.9,52.6C80,51.8,80,50.9,80,50s0-1.8-0.1-2.6l-5.1-0.4c-0.3-2.4-0.9-4.6-1.8-6.7l4.2-2.9c-0.7-1.6-1.6-3.1-2.6-4.5 L70,35c-1.4-1.9-3.1-3.5-4.9-4.9l2.2-4.6c-1.4-1-2.9-1.9-4.5-2.6L59.8,27c-2.1-0.9-4.4-1.5-6.7-1.8l-0.4-5.1C51.8,20,50.9,20,50,20 s-1.8,0-2.6,0.1l-0.4,5.1c-2.4,0.3-4.6,0.9-6.7,1.8l-2.9-4.1c-1.6,0.7-3.1,1.6-4.5,2.6l2.1,4.6c-1.9,1.4-3.5,3.1-5,4.9l-4.5-2.1 c-1,1.4-1.9,2.9-2.6,4.5l4.1,2.9c-0.9,2.1-1.5,4.4-1.8,6.8l-5,0.4C20,48.2,20,49.1,20,50s0,1.8,0.1,2.6l5,0.4 c0.3,2.4,0.9,4.7,1.8,6.8l-4.1,2.9c0.7,1.6,1.6,3.1,2.6,4.5l4.5-2.1c1.4,1.9,3.1,3.5,5,4.9l-2.1,4.6c1.4,1,2.9,1.9,4.5,2.6l2.9-4.1 c2.1,0.9,4.4,1.5,6.7,1.8l0.4,5.1C48.2,80,49.1,80,50,80s1.8,0,2.6-0.1l0.4-5.1c2.3-0.3,4.6-0.9,6.7-1.8l2.9,4.2 c1.6-0.7,3.1-1.6,4.5-2.6L65,69.9c1.9-1.4,3.5-3,4.9-4.9l4.6,2.2c1-1.4,1.9-2.9,2.6-4.5L73,59.8c0.9-2.1,1.5-4.4,1.8-6.7L79.9,52.6 z M50,65c-8.3,0-15-6.7-15-15c0-8.3,6.7-15,15-15s15,6.7,15,15C65,58.3,58.3,65,50,65z" fill="#ffffff"><animateTransform attributeName="transform" type="rotate" from="0 50 50" to="90 50 50" dur="1s" repeatCount="indefinite"></animateTransform></path></g></svg>';
    var SPIN_INFINITY = '<svg width="128px" height="128px" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" xmlns:xlink="http://www.w3.org/1999/xlink" class="uil-inf"><rect x="0" y="0" width="100" height="100" fill="none" class="bk"></rect><path id="uil-inf-path" d="M24.3,30C11.4,30,5,43.3,5,50s6.4,20,19.3,20c19.3,0,32.1-40,51.4-40 C88.6,30,95,43.3,95,50s-6.4,20-19.3,20C56.4,70,43.6,30,24.3,30z" fill="none" stroke="#c0bb9c" stroke-width="1px" stroke-dasharray="5px"></path><circle cx="0" cy="0" r="5" fill="#ff0000"><animateMotion begin="0s" dur="1s" repeatCount="indefinite"><mpath xlink:href="#uil-inf-path"></mpath></animateMotion></circle><circle cx="0" cy="0" r="5" fill="#ff0000"><animateMotion begin="0.08s" dur="1s" repeatCount="indefinite"><mpath xlink:href="#uil-inf-path"></mpath></animateMotion></circle><circle cx="0" cy="0" r="5" fill="#ff0000"><animateMotion begin="0.16s" dur="1s" repeatCount="indefinite"><mpath xlink:href="#uil-inf-path"></mpath></animateMotion></circle><circle cx="0" cy="0" r="5" fill="#ff0000"><animateMotion begin="0.25s" dur="1s" repeatCount="indefinite"><mpath xlink:href="#uil-inf-path"></mpath></animateMotion></circle><circle cx="0" cy="0" r="5" fill="#ff0000"><animateMotion begin="0.33s" dur="1s" repeatCount="indefinite"><mpath xlink:href="#uil-inf-path"></mpath></animateMotion></circle></svg>';
    var SPIN_MAGNIFY = '<svg width="128px" height="128px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" class="uil-magnify"><rect x="0" y="0" width="100" height="100" fill="none" class="bk"></rect><g><circle fill="#8b8bfc" cx="47" cy="47" r="20" opacity="0.5"></circle><path d="M77.5,69.3l-6.2-6.2c-0.7-0.7-1.3-1.2-1.9-1.6c2.6-4,4.1-8.8,4.1-14c0-14.4-11.7-26.1-26.1-26.1S21.3,33.2,21.3,47.5 S33,73.6,47.4,73.6c5.4,0,10.4-1.6,14.5-4.4c0.5,0.7,1.1,1.4,1.9,2.2l5.8,5.8c2.9,2.9,7.1,3.5,9.2,1.3C81,76.4,80.4,72.2,77.5,69.3z M47.4,66.2c-10.3,0-18.7-8.4-18.7-18.6s8.4-18.6,18.7-18.6s18.7,8.4,18.7,18.6S57.7,66.2,47.4,66.2z" fill="#424242"></path><animateTransform attributeName="transform" type="translate" from="15 15" to="15 15" dur="1s" repeatCount="indefinite" values="15 15;-15 15;0 -10.98;15 15" keyTimes="0;0.33;0.66;1"></animateTransform></g></svg>';
    var BLOCK_STATE_SEARCHING = 1;
    var BLOCK_STATE_SEARCH_SELECTION = 2;
    var BLOCK_STATE_PROFILE_UPDATE = 3;
    var BLOCK_STATE_LOD_SELECTION = 4;
    var BLOCK_STATE_LOD_SCAN = 5;


    function blockUser(state) {
        if (state == BLOCK_STATE_SEARCHING) {
            $("#search_box_div").block({message:SPIN_MAGNIFY, overlayCSS: {opacity: 0.2}, css:{backgroundColor:'', border:'none'}});
            $("#gene_information_div").block({message:'', overlayCSS: {opacity: 0.2}, css:{backgroundColor:'', border:'none'}});
            $("#profile_plot_container_div").block({message:'', overlayCSS: {opacity: 0.2}, css:{backgroundColor:'', border:'none'}});
            $("#lod_plot_container_div").block({message:'', overlayCSS: {opacity: 0.2}, css:{backgroundColor:'', border:'none'}});
            $("#secondary_plot_container_div").block({message:'', overlayCSS: {opacity: 0.2}, css:{backgroundColor:'', border:'none'}});
        } else if (state == BLOCK_STATE_SEARCH_SELECTION) {
            $("#search_box_div").block({message:'', overlayCSS: {opacity: 0.2}, css:{backgroundColor:'', border:'none'}});
            $("#gene_information_div").block({message:'', overlayCSS: {opacity: 0.2}, css:{backgroundColor:'', border:'none'}});
            $("#profile_plot_container_div").block({message:SPIN_GEARS, overlayCSS: {opacity: 0.2}, css:{backgroundColor:'', border:'none'}});
            $("#lod_plot_container_div").block({message:SPIN_GEARS, overlayCSS: {opacity: 0.2}, css:{backgroundColor:'', border:'none'}});
            $("#secondary_plot_container_div").block({message:'', overlayCSS: {opacity: 0.2}, css:{backgroundColor:'', border:'none'}});
        } else if (state == BLOCK_STATE_PROFILE_UPDATE) {
            $("#search_box_div").block({message:'', overlayCSS: {opacity: 0.2}, css:{backgroundColor:'', border:'none'}});
            $("#gene_information_div").block({message:'', overlayCSS: {opacity: 0.2}, css:{backgroundColor:'', border:'none'}});
            $("#profile_plot_container_div").block({message:SPIN_GEARS, overlayCSS: {opacity: 0.2}, css:{backgroundColor:'', border:'none'}});
            $("#lod_plot_container_div").block({message:'', overlayCSS: {opacity: 0.2}, css:{backgroundColor:'', border:'none'}});
            $("#secondary_plot_container_div").block({message:'', overlayCSS: {opacity: 0.2}, css:{backgroundColor:'', border:'none'}});
        } else if (state == BLOCK_STATE_LOD_SELECTION) {
            $("#search_box_div").block({message:'', overlayCSS: {opacity: 0.2}, css:{backgroundColor:'', border:'none'}});
            $("#gene_information_div").block({message:'', overlayCSS: {opacity: 0.2}, css:{backgroundColor:'', border:'none'}});
            $("#profile_plot_container_div").block({message:'', overlayCSS: {opacity: 0.2}, css:{backgroundColor:'', border:'none'}});
            $("#lod_plot_container_div").block({message:'', overlayCSS: {opacity: 0.2}, css:{backgroundColor:'', border:'none'}});
            $("#secondary_plot_container_div").block({message:SPIN_GEARS, overlayCSS: {opacity: 0.2}, css:{backgroundColor:'', border:'none'}});
        } else if (state == BLOCK_STATE_LOD_SCAN) {
            $("#search_box_div").block({message:'', overlayCSS: {opacity: 0.2}, css:{backgroundColor:'', border:'none'}});
            $("#gene_information_div").block({message:'', overlayCSS: {opacity: 0.2}, css:{backgroundColor:'', border:'none'}});
            $("#profile_plot_container_div").block({message:'', overlayCSS: {opacity: 0.2}, css:{backgroundColor:'', border:'none'}});
            $("#lod_plot_container_div").block({message:SPIN_GEARS, overlayCSS: {opacity: 0.2}, css:{backgroundColor:'', border:'none'}});
            $("#secondary_plot_container_div").block({message:'', overlayCSS: {opacity: 0.2}, css:{backgroundColor:'', border:'none'}});
        }
        
        /*
        if (state == BLOCK_STATE_GENE_CLICK) {
            $("#portletLODPlotBody").block({message:SPIN_INFINITY, overlayCSS: {opacity: 0}, css:{backgroundColor:'', border:'none'}});
            $("#portletSearchBody").block({message:'', overlayCSS: {opacity: 0}, css:{backgroundColor:'', border:'none'}});
            $("#btnFactPlot").disable(true);
            $(".modebar").addClass("hidden")
        } else if (state === BLOCK_STATE_LOD_CLICK) {
            $("#plot_lod_event_panel").block({message:SPIN_INFINITY, overlayCSS: {opacity: 0}, css:{backgroundColor:'', border:'none'}});
            $("#portletLODPlotBody").block({message:'', overlayCSS: {opacity: 0}, css:{backgroundColor:'', border:'none'}});
            $("#portletSearchBody").block({message:'', overlayCSS: {opacity: 0}, css:{backgroundColor:'', border:'none'}});
            $("#btnFactPlot").disable(true);
            $(".modebar").addClass("hidden")
        }
        */
    }

    function unblockUser(state) {
            $("#search_box_div").unblock();
            $("#gene_information_div").unblock();
            $("#profile_plot_container_div").unblock();
            $("#lod_plot_container_div").unblock();
            $("#secondary_plot_container_div").unblock();
/*
        if (state == BLOCK_STATE_GENE_CLICK) {
            $("#search_box_div").unblock();
            $("#profile_plot_container_div").unblock();
            $("#lod_plot_container_div").unblock();
            $("secondary_plot_container_div").unblock();
        } else if (state === BLOCK_STATE_LOD_CLICK) {
            $("#plot_lod_event_panel").unblock();
            $("#portletLODPlotBody").unblock();
            $("#portletSearchBody").unblock();
            $("#btnFactPlot").disable(false);
            $(".modebar").removeClass("hidden")
        }
        */
    }



    var WHOZ = null;

    function formatMbp(Mbp) {
        return Number(Mbp).toFixed(2);
    }

    function arraymove(arr, fromIndex, toIndex) {
        var element = arr[fromIndex];
        arr.splice(fromIndex, 1);
        arr.splice(toIndex, 0, element);
    }

    // Extended disable function
    jQuery.fn.extend({
        disable: function(state) {
            return this.each(function() {
                var $this = $(this);
                if($this.is('input, button, textarea, select'))
                    this.disabled = state;
                else
                    $this.toggleClass('disabled', state);
            });
        }
    });

    function resetUI() {
    }

    function resetSecondaryPlots() {
        $("#plot_mediation").html('');
        $("#plot_effect").html('');
    }

    function findGene() {
        $("#btnGo").button('loading');
        $("#searchTerm").disable(true);
        var searchTerm = $('#searchTerm').val().trim().toUpperCase();
        if (searchTerm.length == 0) {
            $('#searchTerm').focus();
            $("#btnGo").button('reset');
            $("#searchTerm").disable(false);
            return;
        }

        console.log("Calling api");
        WHOZ.search(searchTerm, {species: 'Mm'}, searchCallback);
    }

    function addHistory(gene_id, protein_id, symbol, level) {
        var unique_id = gene_id;

        if (protein_id) {
            unique_id += "," + protein_id;
        }

        // cookies, everywhere cookie
        var history_data = Cookies.getJSON("history_data");
        var index = -1;

        // build the history of 'clicked' genes
        if (history_data) {
            // move to the top if already here
            for (var i in history_data) {
                if (history_data[i]['id'] === unique_id) {
                    index = i;
                    break;
                }
            }
            if (index > 0) {
                arraymove(history_data, index, 0);
            } else if (index == -1) {
                var history_info = {'id': unique_id, 'g': gene_id, 'p': protein_id, 's': symbol, 'l':level};
                history_data.unshift(history_info);

                if (history_data.length > 20) {
                    history_data.pop();
                }
            } else {
                console.log('doing nothing, returning');
            }
        } else {
            var history_info = {'id': unique_id, 'g': gene_id, 'p': protein_id, 's': symbol, 'l':level};
            history_data = [history_info];
        }

        // attempt to set the cookie, if there is to much data the cookie won't set, so we need to check and adjust the array size
        Cookies.set("history_data", history_data);

    }


    function searchCallback() {
        if (WHOZ.response == null) {
            $('#search_results_div').html("");
            return;
        }

        var response = WHOZ.response;

        console.log('RESPONSE=', response);

        var tbl = '<table id="search_results_table" class="table table-bordered table-hover table-condensed"></table>';
        $('#search_results_div').html(tbl);

        var searchResults = {};
        for (var d in response.result.matches) {
            var _match = response.result.matches[d];
            searchResults[_match.ensembl_gene_id] = _match;
        }

        //console.log(results);

        var _columns = [];

        if (_G.current_level === "mrna") {
            _columns.push({
                title:'ID',
                data:"ensembl_gene_id",
                render: function(data, type, row, meta) {
                    if (type === 'display') {
                        if (_G.genes.gene_ids[data]) {
                            return '<div style="white-space: nowrap"><span id="matchInfo" gene_id="' + data + '" class="glyphicon glyphicon-info-sign"></span> <a href="#" gene_id="' + data + '">' + data + '</a></div>';
                        }else {
                            return '<div style="white-space: nowrap"><span id="matchInfo" gene_id="' + data + '" class="glyphicon glyphicon-info-sign"></span> ' + data + '</div>';
                        }

                    } else {
                        return data;
                    }

                }
            });
        } else {
            _columns.push({
                title:'ID',
                data:"ensembl_gene_id",
                render: function(data, type, row, meta) {
                    if (type === 'display') {
                        //console.log('data=', data);
                        var ps = []
                        if (_G.proteins.gene_ids[data]) {
                            var ret = '<div style="white-space: nowrap"><span id="matchInfo" gene_id="' + data + '" class="glyphicon glyphicon-info-sign"></span> ' + data;
                            ret += '</div><div style="padding-left: 20px;">';
                            ret += '<em>';

                            for (p in _G.proteins.gene_ids[data].protein_ids) {
                                ps.push('<a href="#" gene_id="' + data + '" protein_id="' + _G.proteins.gene_ids[data].protein_ids[p] + '">' + _G.proteins.gene_ids[data].protein_ids[p] + '</a>');
                            }

                            return  ret +  ps.join('<br>') + "</em></div>";

                        }else {
                            return '<div style="white-space: nowrap"><span id="matchInfo" gene_id="' + data + '" class="glyphicon glyphicon-info-sign"></span> ' + data +'</div>';
                        }
                    } else {
                        return data;
                    }

                }
            });
        }

        _columns.push({
                    title:'Symbol',
                    data:"symbol"
                }
        );

        _G.searchTable = $("#search_results_table").DataTable({
            data: response.result.matches,
            paging: false,
            order: [],   // prevent automatic ordering
            scrollY: 200,
            searching: false,
            lengthChange: false,
            scrollCollapse: true,
            responsive: true,
            columns: _columns
        });

        if (response.result.num_results == 1) {
            $('#search_results_table_info').html(response.result.matches.length.toLocaleString() + " result");
        } else if (response.result.matches.num_matches < 100) {
            $('#search_results_table_info').html(response.result.matches.length.toLocaleString() + " results");
        } else {
            $('#search_results_table_info').html("Showing first " + response.result.matches.length.toLocaleString() + " of " + response.result.num_results.toLocaleString() + " results");
        }


        $("#search_results_table a").click(function (e) {
            e.preventDefault();
            var _this = $(this);
            selectGeneProtein(_this.attr('gene_id'), _this.attr('protein_id'));
            return false;
        });


        to = setTimeout(function () {
            $("[id='matchInfo']").each(function () {
                var that = $(this);

                $(this).popover({
                    placement: 'right',
                    html: true,
                    trigger: 'hover',
                    container: 'body',
                    template:'<div class="popover container my-custom-class" role="tooltip"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>',
                    content: function () {
                        //console.log('that=',that);
                        //console.log('that[0].getAttribute("feature_id")=', that[0].getAttribute("feature_id"));
                        var d = searchResults[that[0].getAttribute("gene_id")];
                        var h = '<table class="table table-condensed">';
                        h += '<tr><td><strong>Symbol</strong> </td><td>' + d['symbol'] + '</td></tr>';
                        h += '<tr><td><strong>Location</strong> </td><td>' + d['chromosome'] + ':' + d['position_start'] + '-' + d['position_end'] + '</td></tr>';
                        h += '<tr><td><strong>Name</strong> </td><td>' + d['name'] + '</td></tr>';
                        h += '<tr><td><strong>Synonyms</strong> </td><td>';

                        var s = d['synonyms'];
                        if (s) {
                            if (s.length > 5) {
                                var s2 = s.slice(1, 6);
                                h += s2.join("<br>");
                                h += "<br><i>(" + (s.length - s2.length) + " more synonyms)</i>";
                            } else {
                                h += s.join("<br>");
                            }
                        }
                        h += '</td></tr>';
                        h += '<tr><td><strong>Match Reason</strong> </td><td>' + d['match_reason'] + '</td></tr>';
                        h += '<tr><td><strong>Match Value</strong> </td><td>' + d['match_value'] + '</td></tr>';
                        h += '</table>';

                        return h;
                    }
                });
            });
        });

        _G.searchResults = searchResults;
        _G.searchResultsLevel = _G.current_level;
        $("#btnGo").button('reset');
        $("#searchTerm").disable(false);

        if (Object.keys(_G.searchResults).length == 1) {
            $("#search_results_table a")[0].click();
        }
    }

    // download***   download the data
    // display***      actually put on the screen
    // generate***     call both download and than display

    function generateGeneData(geneID, proteinID) {
        var q = d3.queue()
                .defer(downloadGeneData, geneID)
                .await(function(error, geneData) {
                    console.log('Queue done');
                    console.log('geneData=', geneData);
                    console.log('error=', error);

                    // TODO: handle errors, if error comes back we won't have data

                    if (error) {
                        var message = "Unable to download data for <strong><em>";
                        if (level == "mrna") {
                            message += geneID;
                        } else {
                            message += proteinID;
                        }
                        message += "</em></strong>.";

                        displayError("API Server Error", message);
                        return;
                    }


                    _G.current_gene = geneData[0];
                    displayGeneData(_G.current_gene);
                    //plotLOD(lod_data.data, gene_id, protein_id, level);
                    //unblockUser(BLOCK_STATE_GENE_CLICK);
                });

    }



    /**
     * Handle what should happen upon a new gene selection.
     */
    function selectGeneProtein(geneID, proteinID) {
        blockUser(BLOCK_STATE_SEARCH_SELECTION);
        _G.current_gene_id = geneID;
        _G.current_protein_id = proteinID;
        $("#profile_plot_container_div").removeClass('hidden');
        $("#lod_plot_container_div").removeClass('hidden');
        $("#secondary_plot_container_div").removeClass('hidden');

        var q = d3.queue()
                .defer(downloadGeneData, geneID)
                .defer(downloadLODData, geneID, proteinID, _G.searchResultsLevel)
                .defer(downloadProfileData, geneID, proteinID, getFactorOrder())
                .await(function(error, geneData, lodData, profileData) {
                    console.log('Queue done');
                    console.log('error=', error);

                    if (error) {
                        var message = "Unable to download data for <strong><em>";
                        if (_G.searchResultsLevel == "mrna") {
                            message += geneID;
                        } else {
                            message += proteinID;
                        }
                        message += "</em></strong>.";
                        unblockUser();

                        displayError("API Server Error", message);
                        return;
                    }

                    _G.current_gene = geneData[0];
                    _G.current_gene_id = geneID;
                    _G.current_protein_id = proteinID;
                    displayGeneData(_G.current_gene);
                    resetSecondaryPlots();
                    plotLOD(lodData.data, geneID, proteinID, _G.searchResultsLevel);
                    plotProfile_new(geneID, proteinID, profileData, getFactorOrder());
                    var gene = _G.searchResults[_G.current_gene_id];
                    addHistory(_G.current_gene_id, _G.current_protein_id, gene.symbol, _G.searchResultsLevel);
                    buildHistory();
                    unblockUser();
                });

/*
        $("#profile_plot_container_div").removeClass('hidden');
        $("#lod_plot_container_div").removeClass('hidden');
        $("#secondary_plot_container_div").removeClass('hidden');

        generateGeneData(geneID, proteinID);
        generateLODPlot(geneID, proteinID, _G.searchResultsLevel);
        generateProfilePlot(geneID, proteinID, getFactorOrder());

        var gene = _G.searchResults[_G.current_gene_id];
        addHistory(_G.current_gene_id, _G.current_protein_id, gene.symbol, _G.searchResultsLevel);
        buildHistory();
*/
    }


    /**
    * Plot LOD data.
    *
    * Note: This function can be called without data and wull generate a base graph.
    */
    function plotLOD(data, gene_id, protein_id, level) {
        var dataByChrom = {};
        var maxLOD = -Infinity;
        var minLOD = Infinity;
        var xAxisTitle = '';

        if (data != null) {
            maxLOD = data[0].pheno1;
            minLOD = -2;

            if (level === 'mrna') {
                xAxisTitle = gene_id + " (" + _G.current_gene.symbol + ")";
            } else if (level === 'protein') {
                xAxisTitle = protein_id + " (" + _G.current_gene.symbol + ")";
            } else {
                xAxisTitle = '';
            }

            $.each(data, function(index, element) {
                //
                // element = {"id":"1_12097218","chr":"1","pos":12097218,"pheno1":1.9185}
                //
                var chr = _G.chromosomes.idx[_G.chromosomes.nameToIdx[element.chr]];
                var x = chr.start + (element.pos);
                var y = element.pheno1;

                //
                // chr = {chromosome: "Y", end:2725521390, length: 91744698,
                //        mid: 2679649040, name: "Y", order: 21, start: 2633776692 }
                //
                if (!(chr.chromosome in dataByChrom)) {
                    dataByChrom[chr.chromosome] = {'x': [], 'y': [], 'text': [], 'id': []};
                }

                dataByChrom[chr.chromosome]['x'].push(x);
                dataByChrom[chr.chromosome]['y'].push(y);
                dataByChrom[chr.chromosome]['text'].push(element.pheno1 + '');
                dataByChrom[chr.chromosome]['id'].push(element.id);

                if (element.pheno1 > maxLOD) {
                    maxLOD = element.pheno1;
                }
            });

            maxLOD += 5;
        }


        // TODO: eliminate the lookup for the effect plot to use this, use the saved graph data instead
        _G.lod_traces = {};

        // create traces for each chromosome
        var traces = [];
        $.each(dataByChrom, function(key, value) {
            var trace = {
                type: 'scatter',
                x: value['x'],
                y: value['y'],
                text: value['id'],
                name: key,
                hoverinfo: 'text',
                mode: 'lines',
                opacity: 100.0,
                line: {
                    color: 'rgb(0,0,0)',
                    width: 1
                }

            };

            _G.lod_traces[key] = trace;
            traces.push(trace);
        });


        var plotShapes = [];
        var plotAnnotations = [];

        {% if CONF.PLOT_LOD_LINES %}
        //
        // build the horizontal lines
        //

        var lineVals = [
            {% for l in CONF.PLOT_LOD_LINES %}
                {'val':{{l.val}}, 'color':'{{l.color}}', 'text':'{{l.text }}' },
            {% endfor %}
        ];

        for (var l in lineVals) {
            plotShapes.push({
                type: 'line',
                xref: 'paper',
                x0: 0,
                y0: lineVals[l].val,
                x1: 1,
                y1: lineVals[l].val,
                line: {
                    color: lineVals[l].color,
                    width: 1.5
                },
                layer: 'above',
            });

            plotAnnotations.push({
                x: 1,
                y: lineVals[l].val,
                xref: 'paper',
                yref: 'y',
                text: lineVals[l].text,
                xanchor: 'left',
                yanchor: 'middle',
                showarrow: false,
            });
        }
        {% endif %}

        //
        // build the vertical chromosome bars
        //
        var chromosomeAxisVals = [];
        var chromosomeAxisText = [];

        $.each(_G.chromosomes.idx, function(index, element) {

            chromosomeAxisVals.push(element.mid);
            chromosomeAxisText.push(element.name);

            // TODO: style this
            var fillColor = '#ffffff';
            if ((index % 2) == 0) {
                fillColor = '#222222';
            }
            var s =  {
                type: 'rect',
                // x-reference is assigned to the x-values
                xref: 'x',
                // y-reference is assigned to the paper space (0 to 1)
                yref: 'paper',
                x0: element.start,
                y0: 0,
                x1: element.end,
                y1: 1,
                fillcolor: fillColor,
                opacity: 0.2,
                line: {
                    width: 0.0
                }
            };

            plotShapes.push(s);
        });

        var layout = {
            annotations: plotAnnotations,
            xaxis: {
                title: xAxisTitle,
                showgrid: false,
                zeroline: true,
                showline: true,
                mirror: 'ticks',
                gridcolor: '#bdbdbd',
                gridwidth: 2,
                zerolinecolor: '#969696',
                zerolinewidth: 4,
                linecolor: '#636363',
                linewidth: 1,
                side: 'top',
                autorange: false,
                tickvals: chromosomeAxisVals,
                ticktext: chromosomeAxisText,
                range: [0, _G.chromosomes.totalLength],
                tickfont: {
                    color: 'rgb(0,0,0)',
                    size:12
                },
                tickangle: 0,
            },
            yaxis: {
                title: '{{CONF.PLOT_LOD_XAXIS_TEXT}}',
                showgrid: false,
                zeroline: false,
                showline: true,
                mirror: 'all',
                gridcolor: '#bdbdbd',
                gridwidth: 2,
                zerolinecolor: '#969696',
                zerolinewidth: 1,
                linecolor: '#636363',
                linewidth: 1,
                range: [minLOD, maxLOD],
                tickwidth:2,
                tickmode:'array',
                tickangle: 0,
                fixedrange: true, //Determines whether or not this axis is zoom-able. If true, then zoom is disabled.
            },

            showlegend: false,
            hovermode: 'closest',
            shapes: plotShapes,
        };


        _G.plots.lod.plotly = Plotly.newPlot(_G.plots.lod.el,
            traces,
            layout,
            {
                displayModeBar: true, // true to always display top bar, false to hide
                scrollZoom: false,    // true to allow zoom with mouse wheel, false to prevent
                displaylogo: false,   // true to display Plotly logo, false to hide
                showLink: false,      // true to show edit on Plotly website, false to hide
                modeBarButtonsToRemove: ['sendDataToCloud', 'autoScale2d', 'hoverCompareCartesian', 'hoverClosestCartesian'],
                showTips: false,      // false to disable tips
            }
        );

        var myPlot = document.getElementById(_G.plots.lod.el);

        myPlot.on('plotly_click', function(data){
            console.log('plotly_click=', data);
            var marker = '';
            var pts = '';
            var chromosome = '';
            for(var i=0; i < data.points.length; i++){
                pts = 'x = '+data.points[i].x +'\ny = '+ data.points[i].y.toPrecision(4) + '\n\n';
                console.log(data.points[i].pointNumber);
                console.log(data.points[i].data.text[data.points[i].pointNumber]);

                marker = data.points[i].data.text[data.points[i].pointNumber];
                chromosome = data.points[i].data.name;

            }

            console.log('Closest point clicked:\n\n'+pts);
            var plot=$("#secondaryPlotTabs").find('.active').attr("name");

            console.log('plot=',plot);

            if (plot === "plot_mediation") {
                generateMediationPlot(_G.current_gene_id, marker);
            } else if (plot === "plot_effect") {
                generateEffectPlot(_G.current_gene_id, chromosome);
            } else {
                alert('oops');
            }
        });


        myPlot.on('plotly_hover', function(data){
            console.log('plotly_hover=', data);

            var infotext = data.points.map(function(d){
                return (d.data.name+': x= '+d.x+', y= '+d.y.toPrecision(3));
            });

        }).on('plotly_unhover', function(data){
            //hoverInfo.innerHTML = '';
        });

        $("#plot_lod_event_panel").removeClass('hidden'); // to show
    }

    function plotEffect(effect) {
        console.log('EFFECT=', effect);
        var strainInfo = {};

        {% for s in CONF.PLOT_EFFECT_STRAINS %}
            strainInfo["{{ s['key'] }}"] = {
                'color':"{{ s['color'] }}",
                'name':"{{ s['name'] }}",
                'data':[]
            };
        {% endfor %}

        var x = [];
        var ids = [];

        var chr = null;

        var min_pos = Infinity;
        var max_pos = -Infinity;

        var _currentChromInfo = _G.chromosomes.idx[_G.chromosomes.nameToIdx[_G.current_chromosome]];
        var numTicks = Math.floor(_currentChromInfo.length / 20000000);
        var _x_tick_vals = [];
        var _x_tick_text = [];

        for (var i = 1; i <= numTicks; i++) {
            _x_tick_vals.push(20000000 * i);
            _x_tick_text.push((20 * i) + "Mb")
        }

        $.each(effect.data, function(index, element) {
            //console.log('element=', element);

            //{"A":-0.1224,..."H":1.45,"chr":"4","id":"4_156339889","pos":156.3399}

            strainInfo['A']['data'].push(element.A);
            strainInfo['B']['data'].push(element.B);
            strainInfo['C']['data'].push(element.C);
            strainInfo['D']['data'].push(element.D);
            strainInfo['E']['data'].push(element.E);
            strainInfo['F']['data'].push(element.F);
            strainInfo['G']['data'].push(element.G);
            strainInfo['H']['data'].push(element.H);

            var _pos = element.pos * 1000000;

            x.push(_pos);
            ids.push(element.id);
            chr = element.chr;

            if (max_pos < _pos) {
                max_pos = _pos;
            }
            if (min_pos > _pos) {
                min_pos = _pos;
            }
        });

        console.log('MINPOS========',min_pos);
        console.log('MAXPOS========',max_pos);
        console.log('CHR========',chr);
        var c = _G.chromosomes.idx[_G.chromosomes.nameToIdx[chr]];
        console.log(c);

        var traces = [];

        $.each(strainInfo, function(key, value) {
            traces.push({
                type: 'scatter',
                x: x,
                y: value['data'],
                text: ids,
                //name: value['text'],
                name: value['name'],
                hoverinfo:'text',
                mode: 'lines',
                opacity: 100.0,
                line: {
                    color: value['color'],
                    width: 1.5
                }

            });
        });

        var _title = _G.current_gene_id;

        if (_G.current_level === 'protein') {
            _title =  _G.current_protein_id;
        }

        // TODO: add range


        console.log('x_tick_vals=', _x_tick_vals);
        console.log('x_tick_text=', _x_tick_text);




        var layout = {
            title: _title,
            xaxis: {
                fixedrange: true, // Determines whether or not this axis is zoom-able. If true, then zoom is disabled.
                showgrid: true,
                zeroline: false,
                showline: true,
                mirror: 'all',
                gridcolor: '#bdbdbd',
                gridwidth: 2,
                tickwidth: 1,
                linecolor: '#636363',
                linewidth: 1,
                showticklabels: false, // hide the tick labels on bottom so graph underneath shows up correctly (no bleed through)
            },
            yaxis: {
                fixedrange: true, // Determines whether or not this axis is zoom-able. If true, then zoom is disabled.
                title: 'Founder Effects',
                showgrid: true,
                zeroline: false,
                showline: true,
                mirror: 'all',
                gridcolor: '#dddddd',
                gridwidth: 1,
                tickwidth: 1,
                linecolor: '#636363',
                linewidth: 1
            },

            //shapes: chrom_shapes,
            hovermode: 'closest',

        };

        console.log(traces);


        // ADD BOTTOM TO PLOT
        var temp_trace = _G.lod_traces[_G.current_chromosome];


        //var x_vals = [];
        //for (

        console.log('temp_trace=', temp_trace);

        var bottom_trace = {
            type: 'scatter',
            x: x, //temp_trace['x'],
            y: temp_trace['y'],
            title: 'LOD',
            mode: 'lines',
            opacity: 100.0,
            line: {
                width: 1.5,
                color: 'rgb(0,0,0)',
            },
            xaxis: 'x2',
            yaxis: 'y2',
            showlegend: false,
            hoverinfo:'text',


        };

        console.log('bottom_trace=', bottom_trace);

        layout['yaxis']['domain'] = [.3, 1];

        layout['yaxis2'] = {
            domain: [0, .3],
            fixedrange: true, // Determines whether or not this axis is zoom-able. If true, then zoom is disabled.
            title: 'LOD',
            showgrid: true,
            zeroline: false,
            showline: true,
            mirror: 'all',
            gridcolor: '#dddddd',
            gridwidth: 1,
            tickwidth: 1,
            linecolor: '#636363',
            linewidth: 1
        };


        layout['xaxis2'] = {
            title: 'Chromosome ' + _currentChromInfo.name,
            anchor:'y2',
            fixedrange: true, // Determines whether or not this axis is zoom-able. If true, then zoom is disabled.
            tickvals: _x_tick_vals,
            ticktext: _x_tick_text,
            showgrid: true,
            zeroline: false,
            showline: true,
            mirror: 'all',
            gridcolor: '#bdbdbd',
            gridwidth: 2,
            tickwidth: 1,
            linecolor: '#636363',
            linewidth: 1
        };
        //showlegend: false,

        traces.push(bottom_trace);



        _G.plots.effect.plotly = Plotly.newPlot(_G.plots.effect.el,
                traces,
                layout,
                {

                    displayModeBar: true, // true to always display top bar, false to hide
                    scrollZoom: false,    // true to allow zoom with mouse wheel, false to prevent
                    displaylogo: false,   // true to display Plotly logo, false to hide
                    showLink: false,      // true to show edit on Plotly website, false to hide
                    modeBarButtonsToRemove: ['sendDataToCloud', 'autoScale2d', 'hoverCompareCartesian', 'hoverClosestCartesian'],
                    showTips: false,

                    //modeBarButtonsToAdd: [testButton],
                }
        );

        $("#" + _G.plots.effect.el_wait).html("");

    }



    function plotMediation(data) {
        var x_coord = [];
        var y_coord = [];
        var text = [];

        // probably easier d3 function but just looping for now
        //'LOD': 3.4188, 'chr' : "11", id: "ENSMUSG00000099291", pos:87448734, symbol: "ACEA_U3"

        $.each(data, function(index, element) {
            //console.log('element=', element);
            //if (element.chr in Object.keys(_G.chromosomes.nameToIdx)) {
            if (element.chr in _G.chromosomes.nameToIdx) {

                var chr = _G.chromosomes.idx[_G.chromosomes.nameToIdx[element.chr]];
                var x = chr.start + (element.pos);
                var y = element.LOD;

                /*
                 if (element.chr === 'X') {
                 console.log(chr, x, y);
                 }
                 */

                x_coord.push(x);
                y_coord.push(y);
                text.push(element.symbol);
            } else {
                //console.log(element);
            }
        });

        var traces = [];
        traces.push({
            x: x_coord,
            y: y_coord,
            text: text,
            mode: 'markers',
            type: 'scatter',
            hoverinfo: 'text',
            marker: {
                size: 5,
                color: 'rgb(255,255,255)',
                line: {
                    color: 'rgb(139,26,26)',
                    width: 1
                }
            }
        });

        var axis_tick_vals = [];
        var axis_tick_text = [];

        // rectangles to display
        var chrom_shapes = [];
        var data_chr = {};

        $.each(_G.chromosomes.idx, function(index, element) {

            axis_tick_vals.push(element.mid);
            axis_tick_text.push(element.name);

            data_chr[element.name] = {};
            data_chr[element.name].data = [];

            var fill_color = '#ffffff';
            if ((index % 2) == 0) {
                fill_color = '#222222';
            }
            var s =  {
                type: 'rect',
                // x-reference is assigned to the x-values
                xref: 'x',
                // y-reference is assigned to the paper space (0 to 1)
                yref: 'paper',
                x0: element.start,
                y0: 0,
                x1: element.end,
                y1: 1,
                fillcolor: fill_color,
                layer: 'above',
                opacity: 0.2,
                line: {
                    width: 0.0
                },
            };

            chrom_shapes.push(s);
        });


        //console.log(JSON.stringify(chrom_shapes));

        var data = [];


        var _title = _G.current_gene_id;

        if (_G.current_level === 'protein') {
            _title =  _G.current_protein_id;
        }

        var layout = {
            title: _title,
            xaxis: {
                showgrid: false,
                zeroline: true,
                showline: true,
                mirror: 'ticks',
                gridcolor: '#bdbdbd',
                gridwidth: 2,
                zerolinecolor: '#969696',
                zerolinewidth: 4,
                linecolor: '#636363',
                linewidth: 1,
                side: 'top',
                autorange: false,
                tickvals: axis_tick_vals,
                ticktext: axis_tick_text,
                range: [0, _G.chromosomes.totalLength],
                tickfont: {
                    color: 'rgb(0,0,0)',
                    size:12
                },
                tickangle: 0,

            },
            yaxis: {
                title: 'lod',
                showgrid: false,
                zeroline: false,
                showline: true,
                mirror: 'all',
                gridcolor: '#bdbdbd',
                gridwidth: 2,
                zerolinecolor: '#969696',
                zerolinewidth: 1,
                linecolor: '#636363',
                linewidth: 1,
                //range: [-2,22],
                tickwidth:2,
                tickmode:'array',
                tickangle: 0,

            },

            showlegend: false,
            shapes: chrom_shapes,
            hovermode: 'closest',

        };

        _G.plots.mediation.plotly = Plotly.newPlot(_G.plots.mediation.el,
                traces,
                layout,
                {
                    scrollZoom: false,
                    displaylogo: false,
                    showLink: false,
                    modeBarButtonsToRemove: ['sendDataToCloud', 'autoScale2d', 'hoverCompareCartesian', 'hoverClosestCartesian'],
                    logging: 5,
                }
        );

        $("#" + _G.plots.mediation.el_wait).html("");
    }

    function plotProfile_new(ensembl_gene_id, ensembl_protein_id, profile_data, profiles) {


        var profile_info = {};

        $.each(profile_data.data_types, function(key, value) {

            profile_info[key] = {levels: value, name: key, kind: "factor", values: []};
        });

        console.log('profile_info=',profile_info);


        var samples = [];
        var expression = [];

        $.each(profile_data.data, function(index, element) {
            samples.push(element.mouse_id);

            $.each(profile_data.data_types, function(key, value) {
                profile_info[key].values.push(element[key]+"");
            });

            expression.push(element.expression);
        });


        var xvar = [];
        $.each(profiles, function(index, element) {
            xvar.push(profile_info[element]);
        });


        var yname = ensembl_gene_id;
        if (_G.current_level == "mrna") {
            yname = ensembl_gene_id;
        } else {
            yname = ensembl_protein_id;
        }



        var yvar = [];
        yvar.push({
            kind: "number",
            name: yname,
            values: expression,
        });




        var plotParams = {
            //title: ensembl_id,
            sampleCount: samples.length,
            xAxis: {
                jitterPx: 25,
                min: null,
                max: null,
                variables: xvar,
                tickLabelRotationDeg: -45
            },
            yAxis: {
                min: null,
                max: null,
                variables: yvar,
                whiskers: {
                    units: "stderr",
                    dist: 1
                }
            }
        };

        _G.fact = {};

        _G.fact.plotParams = plotParams;

        _G.fact.samples = samples;

        // using this so plots have same jitter

        Math.seedrandom('whozapi');


        _G.fact.jsobject = new FactExpPlot({
            svg: d3.select("#fact-svg-chart"),
            pointSizePx: 5,
        });

        // not using mouseOverPoint because it wasn't showing tooltip on initial hover
        /*
         _G.fact.jsobject.mouseOverPoint = function(a, b) {
         console.log(a, b);
         console.log($(b));
         $(b).popover({
         placement: 'auto',
         html: true,
         trigger: 'hover',
         container: 'body',
         content: function () {
         return _G.fact.samples[a];
         }
         });
         }*/


        /**
         * Here we do some styling.  This is hard coded right now.
         */
        _G.fact.jsobject.postProcessPoint = function(sampleIndex, d3Node) {
            //console.log(sampleIndex, d3Node);
            //console.log(profile_info['sex'].values[sampleIndex]);
            d3Node.classed("female", profile_info['sex'].values[sampleIndex] == "F");
            d3Node.classed("male", profile_info['sex'].values[sampleIndex] == "M");

            if (profile_info['age'].values[sampleIndex] == "6") {
                _G.fact.jsobject.setPointShape(d3Node, DataPointShape.SQUARE);
            } else if (profile_info['age'].values[sampleIndex] == "12") {
                _G.fact.jsobject.setPointShape(d3Node, DataPointShape.DIAMOND);
            } else if (profile_info['age'].values[sampleIndex] == "12") {
                _G.fact.jsobject.setPointShape(d3Node, DataPointShape.STAR);
            }


        };

        _G.fact.jsobject.renderPlot(plotParams);


        $("#points-group use").each(function () {
            var that = $(this);
            var sample_index = parseInt($(this).attr('sample-index'));
            $(this).popover({
                placement: 'left',
                html: true,
                trigger: 'hover',
                container: 'body',
                content: function () {
                    return _G.fact.samples[sample_index];
                }
            });
        });




    }




    /**
     * Download LOD scan data from the server
     */
    function downloadLODData(gene_id, protein_id, level, callback) {
        var _url = _G.url_apis.lod + "/" + level;

        if (level == "mrna") {
            _url += "?id=" + gene_id;
        } else {
            _url += "?id=" + protein_id;
        }

        if (_G.cond === "local") {
            _url += "&regress_local=TRUE";
        }

        var cache_url = _G.url_proxy + _url;
        console.log("AJAX request to: ", cache_url);

        $.ajax({
            url: cache_url,
            method: "GET"
        }).done(function(data, textStatus, jqXHR) {
            console.log("lod download success", data);
            callback(null, data);
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.log("lod download failure");
            callback(errorThrown, null);
        });
    }


    function downloadMediationData(ensembl_id, marker_id, callback) {
        var _url = _G.url_apis.mediate + "?id=" + ensembl_id + "&" + "mid=" + marker_id;
        var cache_url = _G.url_proxy + _url;
        console.log("AJAX request to: ", cache_url);

        $.ajax({
            url: cache_url,
            method: "GET"
        }).done(function(data, textStatus, jqXHR) {
            console.log("mediate download success", data);
            callback(null, data);
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.log("mediate download failure");
            callback(errorThrown, null);
        });

    }

    function downloadEffectData(ensembl_id, chromosome, callback) {
        var _url = _G.url_apis.effect + "?id=" + ensembl_id + "&" + "chr=" + chromosome;

        if ($("#mediate_blup").is(':checked')) {
            _url += '&blup=TRUE';
        }

        if (_G.cond === "local") {
            _url += "&regress_local=TRUE";
        }

        var cache_url = _G.url_proxy + _url;
        console.log("AJAX request to: ", cache_url);

        $.ajax({
            url: _url,
            method: "GET"
        }).done(function(data, textStatus, jqXHR) {
            console.log("foundercoefs download success", data);
            callback(null, data);
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.log("foundercoefs download failure");
            callback(errorThrown, null);
        });

    }

    function downloadProfileData(ensembl_gene_id, ensembl_protein_id, profiles, callback) {
        var _url = _G.url_apis.expression + "/" + _G.current_level;

        if (_G.current_level == "mrna") {
            _url += "?id=" + ensembl_gene_id;
        } else {
            _url += "?id=" + ensembl_protein_id;
        }

        var cache_url = _G.url_proxy + _url;
        console.log("AJAX request to: ", cache_url);

        $.ajax({
            url: cache_url,
            method: "GET"
        }).done(function(data, textStatus, jqXHR) {
            console.log("expression download success", data);
            callback(null, data);
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.log("expression download failure");
            callback(errorThrown, null);
        });
    }

    function downloadGeneData(geneID, callback) {
        var URL = _G.url_apis.genes + geneID;
        var cacheURL = _G.url_proxy + URL;
        //var cache_url = _url;
        console.log("AJAX request to: ", cacheURL);

        $.ajax({
            url: cacheURL,
            method: "GET"
        }).done(function(data, textStatus, jqXHR) {
            console.log("gene download success", data);
            callback(null, data);
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.log("gene download failure");
            callback(errorThrown, null);
        });
    }


    function generateLODPlot(geneID, proteinID, level) {
        blockUser(BLOCK_STATE_LOD_SCAN);
        _G.current_gene_id = geneID;
        _G.current_protein_id = proteinID;

        resetSecondaryPlots();

        var q = d3.queue()
                //.defer(downloadGeneInformation, gene_id)
                .defer(downloadLODData, geneID, proteinID, level)
                .await(function(error, lod_data) {
                    console.log('Queue done');
                    console.log('lod_data=', lod_data);
                    console.log('error=', error);

                    // TODO: handle errors, if error comes back we won't have data

                    if (error) {
                        var _message = "Unable to download data for <strong><em>";
                        if (level == "mrna") {
                            _message += geneID;
                        } else {
                            _message += proteinID;
                        }
                        _message += "</em></strong>.";

                        displayError("API Server Error", _message);
                        unblockUser();

                        return;
                    }
                    plotLOD(lod_data.data, geneID, proteinID, level);
                    unblockUser();
                });
    }

    function generateMediationPlot(ensembl_id, marker_id) {
        blockUser(BLOCK_STATE_LOD_SELECTION);

        var q = d3.queue()
                .defer(downloadMediationData, ensembl_id, marker_id)
                .await(function(error, data) {
                    console.log('Queue done');

                    // TODO: handle errors, if error comes back we won't have data
                    if (error) {
                        var _message = "Unable to download mediation data for <strong><em>";
                        _message += ensembl_id;
                        _message += "</em></strong> on ";
                        _message += "<strong><em>";
                        _message += marker_id;
                        _message += "</em></strong>";

                        displayError("API Server Error", _message);
                        unblockUser();
                        return;
                    }

                    console.log("PLOT MEDIATE");
                    plotMediation(data);
                    unblockUser();
                });
    }

    function generateEffectPlot(ensembl_id, chromosome) {
        blockUser(BLOCK_STATE_LOD_SELECTION);
        _G.current_chromosome = chromosome;
        console.log(ensembl_id, chromosome);

        var q = d3.queue()
                .defer(downloadEffectData, ensembl_id, chromosome)
                .await(function(error, data) {
                    console.log('Queue done');
                    console.log('data=', data);

                    // TODO: handle errors, if error comes back we won't have data
                    if (error) {
                        var _message = "Unable to download effect data for <strong><em>";
                        _message += ensembl_id;
                        _message += "</em></strong> on chromosome ";
                        _message += "<strong><em>";
                        _message += chromosome;
                        _message += "</em></strong>";

                        displayError("API Server Error", _message);
                        unblockUser();
                        return;
                    }

                    console.log("PLOT EFFECT")
                    plotEffect(data);
                    unblockUser();


                });
    }

    function generateProfilePlot(ensembl_gene_id, ensembl_protein_id, profiles) {
        blockUser(BLOCK_STATE_PROFILE_UPDATE);
        console.log("Generating profile plot", ensembl_gene_id, ensembl_protein_id, profiles);
        var q = d3.queue()
                .defer(downloadProfileData, ensembl_gene_id, ensembl_protein_id, profiles)
                .await(function(error, data) {
                    console.log('Queue done');
                    console.log('data=', data);

                    // TODO: handle errors, if error comes back we won't have data
                    if (error) {
                        var _message = "Unable to download profile data for <strong><em>";
                        _message += ensembl_id;
                        _message += "</em></strong>.";

                        displayError("API Server Error", _message);
                        unblockUser();
                        return;
                    }

                    console.log("PLOT PROFILE")
                    plotProfile_new(ensembl_gene_id, ensembl_protein_id, data, profiles);
                    unblockUser();


                });
    }

    function loadOptions(callback) {
        /*
         From d3.js documentation:

         When a task completes, it must call the provided callback.

         The first argument to the callback should be null if the task is successfull,
         or the error if the task failed.

         The optional second argument to the callback is the return value of the task.
         (To return multiple values from a single callback, wrap the results in an object or array.)
         */
        var _url = _G.url_proxy + _G.url_apis.options;
        $.ajax({
            url: _url,
            method: "GET"
        }).done(function(data, textStatus, jqXHR) {
            console.log("options download success");
            console.log("options=", data);
            callback(null, data);
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.log("options download failure");
            callback(errorThrown, null);
        });
    }

    function loadChromsomes(callback) {
        var _url = _G.url_chromosomes;
        console.log("Downloading chromosomes: ", _url);

        $.ajax({
            url: _url,
            method: "GET"
        }).done(function(data, textStatus, jqXHR) {
            console.log("chromosome download success");
            console.log('chromosome data=',data);
            callback(null, data);
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.log("chromosome download failure");
            console.log("genes download failure");
            console.log('jqXHR=', jqXHR);
            console.log('textStatus=', textStatus);
            console.log('errorThrown=', errorThrown);
            displayError("Server Error", "Unable to download chromosome information");
            callback(errorThrown, null);
        });
    }

    function loadGenes(callback) {
        var _url = _G.url_proxy + _G.url_apis.ids + "?id_type=mrna";
        console.log("Downloading genes: ", _url);

        $.ajax({
            url: _url,
            method: "GET"
        })
                .done(function(data, textStatus, jqXHR) {
                    console.log("genes download success", data);
                    callback(null, data);
                }).fail(function(jqXHR, textStatus, errorThrown) {
            console.log("genes download failure");
            console.log('jqXHR=', jqXHR);
            console.log('textStatus=', textStatus);
            console.log('errorThrown=', errorThrown);
            displayError("API Server Error", "Error downloading gene information");
            callback(errorThrown, null);
        });
    }

    function loadProteins(callback) {
        var _url = _G.url_proxy + _G.url_apis.ids + "?id_type=protein";
        console.log("Downloading proteins: ", _url);

        $.ajax({
            url: _url,
            method: "GET"
        })
                .done(function(data, textStatus, jqXHR) {
                    console.log("proteins download success");
                    callback(null, data);
                }).fail(function(jqXHR, textStatus, errorThrown) {
            console.log("proteins download failure");
            console.log('jqXHR=', jqXHR);
            console.log('textStatus=', textStatus);
            console.log('errorThrown=', errorThrown);
            displayError("API Server Error", "Error downloading protein information");
            callback(errorThrown, null);
        });
    }

    function findBootstrapEnvironment() {
        var envs = ["xs", "sm", "md", "lg"];
        var doc = window.document;
        var temp = doc.createElement("div");

        doc.body.appendChild(temp);

        for (var i = envs.length - 1; i >= 0; i--) {
            var env = envs[i];

            temp.className = "hidden-" + env;

            if (temp.offsetParent === null) {
                doc.body.removeChild(temp);
                return env;
            }
        }
        return "";
    }

    // Returns a function, that, as long as it continues to be invoked, will not
    // be triggered. The function will be called after it stops being called for
    // N milliseconds. If `immediate` is passed, trigger the function on the
    // leading edge, instead of the trailing.
    function debounce(func, wait, immediate) {
        var timeout;
        return function() {
            var context = this, args = arguments;
            var later = function() {
                timeout = null;
                if (!immediate) func.apply(context, args);
            };
            var callNow = immediate && !timeout;
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
            if (callNow) func.apply(context, args);
        };
    };
    /*
     var debounceLayoutCheck = debounce(function() {
     var bse = findBootstrapEnvironment();
     console.log('bse=',bse);

     if (_G.bootstrapEnv != bse) {
     console.log(_G.bootstrapEnv + ' != ' + bse + ' so redrawing')

     // resize all the graphs
     $.each($(".js-plotly-plot"), function(index, element) {
     Plotly.Plots.resize($("#" + $(element).attr("id"))[0]);
     });
     _G.fact.jsobject.renderPlot(_G.fact.plotParams);

     _G.bootstrapEnv = bse;
     }
     }, 250);
     */
    var debounceLayoutCheck = debounce(function() {
        console.log('redrawing');
        Plotly.Plots.resize($("#plot_lod")[0]);
    }, 250);

    function getFactorOrder() {
        var selected = [];
        $('#factor-view-select option:selected').each(function() {
            selected.push([$(this).val(), $(this).attr('order')]);
        });

        selected.sort(function(a, b) {
            return a[1] - b[1];
        });

        var ordered = [];
        for (var i = 0; i < selected.length; i++) {
            ordered.push(selected[i][0]);
        }

        console.log('ordered=',ordered);

        return ordered;

    }



    function displayError(_title, _message) {
        $.notify({
            title:"<h5>" + _title + "</h5>",
            message:_message
        }, {
            type: 'danger'
        });

        // make sure all waiting images are no longer
        $.each($("div[id$='wait']"), function(index, element) {
            $(element).html("");
        });
    }

    function displayGeneData(geneData) {
        console.log(geneData);
        var startFormat = formatMbp(geneData.start/1000000);
        var endFormat = formatMbp(geneData.end/1000000);
        var mbpDesc = 'Mbp';

        if ( startFormat < 1) {
            startFormat = geneData.start;
            endFormat = geneData.end;
            mbpDesc = 'bp';
        }

        var synonyms = "";

        if (geneData.synonyms) {
            synonyms = geneData.synonyms.join("<br>");
        }

        var strand = "forward";

        if (geneData.strand === "-") {
            strand = "negative";
        }

        var htmlBody = `                    <div class="row">
                        <div class="col-md-12">
<dl class="dl-horizontal">
                            <dt>ID</dt><dd>${geneData.id||''}
                [
                <a target="_newwin" href="http://www.ensembl.org/id/${geneData.id}">Ensembl <small><i class="fa fa-external-link fa-1" aria-hidden="true"></i></small></a>

                <a target="_newwin" href="http://www.informatics.jax.org/marker/${geneData.id}">MGI <small><i class="fa fa-external-link fa-1" aria-hidden="true"></i></small></a>
                ]
                            </dd>
                            <dt>Symbol</dt><dd>${geneData.symbol||''}</dd>
                            <dt>Chromosome</dt><dd>${geneData.chromosome||''}</dd>
                            <dt>Start Position</dt><dd>${geneData.start||''}</dd>
                            <dt>End Position</dt><dd>${geneData.end||''}</dd>
                            <dt>Strand</dt><dd>${geneData.strand||''}</dd>
                            <dt>Description</dt><dd>${geneData.description||''}</dd>
                            <dt>Synonyms</dt><dd>${synonyms||''}</dd>
                </dl></div></div>`;




        var htmlHeader = `<h3 class="box-title">${geneData.id} <em>${geneData.symbol}</em></h3>
                Chromosome ${geneData.chromosome} (${startFormat} - ${endFormat} ${mbpDesc}, ${strand} strand)
                    <div class="box-tools pull-right">
                        <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-plus"></i>
                        </button>
                    </div>
`;

        $("#div_current_gene_information_body").html(htmlBody);
        $("#div_current_gene_information_header").html(htmlHeader);
        console.log('Done displaying gene information:', geneData.id);
    }

    function cookiesEnabled() {
        var isValid = Cookies.set('checkme', 'valid', {expires: 1}) && Cookies.get('checkme') === 'valid';
        Cookies.remove('checkme');
        return isValid;
    }

    function buildHistory() {
        // cookies, everywhere cookie
        var history_data = Cookies.getJSON("history_data");

        var historyTableData = [];
        var historyDict = {};

        for (var _h in history_data) {
            var h = history_data[_h];
            var d = {
                'gene_id': h['g'],
                'symbol': h['s'],
                'protein_id': h['p'],
                'level': h['l']
            };

            historyDict[h['id']] = {'symbol': h['s'], 'level': h['l']};

            historyTableData.push(d);
        }

        console.log('historyTableData=', historyTableData);


        console.log('checking history');
        if (!cookiesEnabled()) {
            $('#search_history_div').html("<br><span class='text-danger'>History requires that cookies are enabled in your browser.</span>");
            return;
        }

        if (history_data) {
            if (history_data.length == 1) {
                $('#searchHistoryStatus').html("<p class='text-right text-muted'><em><small>Showing last gene viewed</small></em></p>");
            } else {
                $('#searchHistoryStatus').html("<p class='text-right text-muted'><em><small>Showing last " + history_data.length.toLocaleString() + " genes viewed</small></em></p>");
            }

            var tbl = '<table id="search_history_table" class="table table-bordered table-hover table-condensed"></table>';
            $('#search_history_div').html(tbl);

            var historyTableColumns = [];

            historyTableColumns.push({
                title:'ID',
                data:"gene_id",
                render: function(data, type, row, meta) {
                    if (row['level'] === 'mrna') {
                        if (type === 'display') {
                            if (_G.genes.gene_ids[data]) {
                                return '<div style="white-space: nowrap"><a href="#" gene_id="' + data + '">' + data + '</a></div>';
                            }

                            return '<div style="white-space: nowrap">' + data + '</div>';
                        }

                        return data;
                    } else {
                        if (type === 'display') {
                            console.log('data=', data);
                            var ps = [];
                            if (_G.proteins.gene_ids[data]) {
                                var ret = '<div style="white-space: nowrap">' + data;
                                ret += '</div><div style="padding-left: 20px;">';
                                ret += '<em>';

                                for (p in _G.proteins.gene_ids[data].protein_ids) {
                                    ps.push('<a href="#" gene_id="' + data + '" protein_id="' + _G.proteins.gene_ids[data].protein_ids[p] + '">' + _G.proteins.gene_ids[data].protein_ids[p] + '</a>');
                                }

                                return ret + ps.join('<br>') + "</em></div></small>";

                            }

                            return '<div style="white-space: nowrap">' + data + '</div>';
                        }

                        return data;
                    }
                }
            });

            historyTableColumns.push({
                        title:'Symbol',
                        data:"symbol"
                    }
            );


            _G.historyTable = $("#search_history_table").DataTable({
                data: historyTableData,
                paging: false,
                order: [],   // prevent automatic ordering
                scrollY: 200,
                searching: false,
                //lengthChange: false,
                //scrollCollapse: true,
                columns: historyTableColumns,
                autoWidth:true,
                responsive:true,
            });

            console.log('done');

            $("#search_history_table a").click(function (e) {
                e.preventDefault();

                var _this = $(this);
                console.log(_this);

                _G.current_gene_id = _this.attr('gene_id');
                _G.current_protein_id = _this.attr('protein_id');

                var unique_id = _G.current_gene_id;

                if (_G.current_protein_id) {
                    unique_id += "," + _G.current_protein_id;
                }


                resetUI();

                addHistory(_G.current_gene_id, _G.current_protein_id, historyDict[unique_id]['symbol'], historyDict[unique_id]['level']);
                buildHistory();

                // make sure the profile plot is now visible
                $("#profilePlot").removeClass("hidden");

                generateLODPlot(_G.current_gene_id, _G.current_protein_id, historyDict[unique_id]['level']);

                return false;
            });

        } else {
            $('#search_history_div').html("<br><span class='text-danger'>No results found.</span>");
        }

    }


    function init() {
        console.log('initializing...');





        _G.bootstrapEnv = findBootstrapEnvironment();
        window.addEventListener('resize', debounceLayoutCheck);

        $('#searchTerm').keypress(function(e) {
            var code = e.which ? e.which : e.keyCode;
            if (code === 13) {
                $(this).blur();
                $('#btnGo').focus().click();
            }
        });

        $('#btnGo').button().click(function() {
            findGene();
            return false;
        });


        $('#lbl_level_mrna').on("click", function() {

            _G.current_level = "mrna";
            findGene();

            // TODO: clear lod if PROTEIN and lod mrna
            // what if multiple proteins?
            //return false;
        });

        $('#lbl_level_protein').on("click", function() {
            _G.current_level = "protein";
            findGene();

            // TODO: clear lod if MRNA and lod protein
            // what if multiple proteins?
            //return false;
        });

        $('#lbl_default').on("click", function() {
            _G.cond = "default";
            if (_G.current_gene_id != null) {
                generateLODPlot(_G.current_gene_id, _G.current_protein_id, _G.current_level);
            }

        });

        $('#lbl_local').on("click", function() {
            _G.cond = "local";
            if (_G.current_gene_id != null) {
                generateLODPlot(_G.current_gene_id, _G.current_protein_id, _G.current_level);
            }
        });


        _G.orderCount = getFactorOrder().length;




        $('#factor-view-select').multiselect({
            onChange: function(option, checked) {
                if (checked) {
                    _G.orderCount++;
                    $(option).attr('order', _G.orderCount);
                }
                else {
                    $(option).attr('order', '');
                }
            },
            maxHeight: 400,
            dropUp: false,
            buttonWidth: '100%',
            buttonText: function(options) {
                if (options.length === 0) {
                    return 'None selected';
                }
                else {
                    var selected = [];
                    options.each(function() {
                        selected.push([$(this).text(), $(this).attr('order')]);
                    });

                    selected.sort(function(a, b) {
                        return a[1] - b[1];
                    });

                    var text = '';
                    for (var i = 0; i < selected.length; i++) {
                        text += ((i+1) + ": " + selected[i][0] + ', ');
                    }

                    return text.substr(0, text.length -2);
                }
            },
        });


        $("#btnFactPlot").on('click', function() {
            console.log("getFactorOrder=", getFactorOrder());
            generateProfilePlot(_G.current_gene_id, _G.current_protein_id, getFactorOrder());
        });

        // make sure search tables draw correctly
        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            if (_G.searchTable) {
                _G.searchTable.draw();
            }
            if (_G.historyTable) {
                _G.historyTable.draw();
            }
        });

        console.log('DONE initializing!')
    }

    $().ready(function () {
        init();

        WHOZ = new whoz({
            search_limit: 100,
        });

        console.log('Starting Queue...');
        var q = d3.queue()
                .defer(loadOptions)
                .defer(loadChromsomes)
                .defer(loadGenes)
                .defer(loadProteins)
                .await(function(error, options, chromosomes, genes, proteins) {
                    console.log('Queue done');

                    // TODO: handle errors, if error comes back we won't have data
                    if (error) {
                        console.log('ERROR: ', error);
                        //displayError(error);
                        //throw error;
                        return;
                    }

                    console.log(options);

                    _G.chromosomes = {'idx': chromosomes.chromosomes, 'nameToIdx': {}};

                    $.each(chromosomes.chromosomes, function(index, element) {
                        _G.chromosomes['nameToIdx'][element.name] = index;
                    });

                    _G.chromosomes['totalLength'] = _G.chromosomes.idx[_G.chromosomes.idx.length-1].end;


                    console.log(genes);
                    var _gene_ids = {};

                    $.each(genes.ids, function(index, element) {
                        //console.log(index, element);
                        if (!(element.gene_id in _gene_ids)) {
                            _gene_ids[element.gene_id] = {'id': element.gene_id}
                        }
                    });

                    _G.genes = {gene_ids:_gene_ids};
                    console.log('genes=', _G.genes);

                    console.log(proteins);
                    _gene_ids = {};
                    var _protein_ids = [];

                    $.each(proteins.ids, function(index, element) {
                        //console.log(index, element);
                        if (!(element.gene_id in _gene_ids)) {
                            _gene_ids[element.gene_id] = {'id': element.gene_id, 'protein_ids':[]}
                        }
                        _protein_ids.push(element.protein_id)
                        _gene_ids[element.gene_id]['protein_ids'].push(element.protein_id);
                    });

                    _G.proteins = {gene_ids:_gene_ids, proteins_ids: _protein_ids};
                    console.log('proteins=', _G.proteins);


                    buildHistory();

                    {% if search_term %}
                        console.log('Finding gene now...');
                        findGene();
                    {% else %}
                        resetUI();
                    {% endif %}

                    console.log('done');

                });
    });
    //-->
</script>



</body>
</html>
