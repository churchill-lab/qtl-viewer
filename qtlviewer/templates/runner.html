<!--
Copyright (c) 2015 Matthew Vincent, The Churchill Lab

This software was developed by Gary Churchill's Lab.
(see http://research.jax.org/faculty/churchill)

This is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This software is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this software. If not, see <http://www.gnu.org/licenses/>.
//-->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

    <title>QTL Viewer</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="{{request.URL_BASE}}/static/bootstrap-3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{request.URL_BASE}}/static/font-awesome-4.4.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="{{request.URL_BASE}}/static/DataTables-1.10.12/media/css/dataTables.bootstrap.min.css">
    <link rel="stylesheet" href="{{request.URL_BASE}}/static/bootstrap-switch/css/bootstrap3/bootstrap-switch.min.css">
    <link rel="stylesheet" href="{{request.URL_BASE}}/static/bootstrap-select/css/bootstrap-select.min.css">
    <link rel="stylesheet" href="{{request.URL_BASE}}/static/bootstrap-multiselect/css/bootstrap-multiselect.css">
    <link rel="stylesheet" href="{{request.URL_BASE}}/static/css/style.css">
    <!--
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu">
    //-->
    <link rel="shortcut icon" href="{{request.URL_BASE}}/static/images/favicon.ico">


    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>
    <div id="content" class="container-fluid">
        <div class="row" style="margin-top: 5px">
            <div class="col-sm-4">
                <div class="row">
                    <div class="col-sm-12">
                        <!--

                        START SEARCH

                        //-->
                        <div id="portletSearch" class="portlet">
                            <div class="portlet-title">
                                <div class="caption">
                                    <i class="glyphicon glyphicon-search"></i>
                                    <span class="caption-subject bold font-yellow-crusta uppercase">Search</span>
                                    <span class="caption-helper"></span>
                                </div>
                            </div>
                            <div class="portlet-body">
                                <div class="row">
                                    <div class="col-sm-8">
                                        <strong>Level</strong>
                                        <div class="btn-group" data-toggle="buttons">
                                            <label id="lbl_mrna" class="btn btn-xs btn-default active">
                                                <input type="radio" name="search_level" id="level_mrna" value="mrna" autocomplete="off" checked> mRNA
                                            </label>
                                            <label id="lbl_protein" class="btn btn-xs btn-default">
                                                <input type="radio" name="search_level" id="level_protein" value="protein" autocomplete="off"> Protein
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="row row-spacer">
                                </div>
                                <div class="row">
                                    <div class="col-sm-12">
                                        <div class="input-group">
                                            <input type="text" id="searchTerm" class="form-control input-circle-left" placeholder="Example: Kit, Ren1"  value="{{ search_term }}">
                                            <span class="input-group-btn">
                                                <button id="btnGo" class="btn btn-circle-right btn-primary" data-loading-text="<i class='fa fa-spinner fa-spin'></i>" type="submit">Go!</button>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-12">
                                        <div id="searchResults"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!--

                        END SEARCH

                        //-->
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12">
                        <!--

                        START PROFILE PLOTS

                        //-->
                        <hr>
                        <div class="row">
                            <div class="col-sm-offset-1 col-sm-8">
                                <div id="factor-view-select-wrapper">
                                    <select id="factor-view-select" multiple="multiple">
                                        <option value="age" order="1" selected>Age</option>
                                        <option value="sex" order="2">Sex</option>
                                        <option value="generation" order="3">Generation</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-sm-2">
                                <button id="btnFactPlot" type="button" class="btn btn-sm btn-primary">Update</button>
                            </div>
                        </div>
                        <div class="row row-spacer">
                        </div>
                        <div class="row">
                            <div class="col-sm-offset-1 col-sm-10">
                                <div id="fact-svg-panel">
                                    <svg id="fact-svg-chart" width="100%" height="400px"></svg>
                                </div>
                            </div>
                        </div>
                        <!--

                        END PROFILE PLOTS

                        //-->
                    </div>
                </div>
            </div>
            <div class="col-sm-8">
                <div class="row">
                    <div class="col-sm-12">
                        <!--

                        START PLOTS ON RIGHT SIDE

                        //-->
                        <div id="portletLODPlot" class="portlet margin-bottom-30">
                            <div class="portlet-title">
                                <div class="caption">
                                    <i class="fa fa-line-chart"></i>
                                    <span class="caption-subject bold font-yellow-crusta uppercase">LOD Plot</span>
                                    <span class="caption-helper"></span>
                                </div>
                            </div>
                            <div class="portlet-body">
                                <div class="row">
                                    <div class="col-sm-12">
                                        <div id="current_gene_information"></div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-12">
                                        <strong>Scan Type</strong>
                                        <div class="btn-group" data-toggle="buttons">
                                            <label id="lbl_default" class="btn btn-xs btn-default active">
                                                <input type="radio" name="cond" id="cond_default" value="default" autocomplete="off" checked> Default
                                            </label>
                                            <label id="lbl_local" class="btn btn-xs btn-default">
                                                <input type="radio" name="cond" id="cond_local" value="local" autocomplete="off"> Local
                                            </label>
                                        </div>
                                    </div>
                                    <!--

                                    START LOD PLOT

                                    //-->
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <div id="plot_lod_wait" style="text-align: center"></div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <div id="plot_lod" style="width: 100%; height: 100%"></div>
                                        </div>
                                    </div>
                                    <!--

                                    END LOD PLOT

                                    //-->
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <div id="plot_lod_event_panel" class="hidden">
                                                <strong>Graph to plot on selection</strong>
                                                <!-- Nav tabs -->
                                                <ul id="secondaryPlotTabs" class="nav nav-tabs" role="tablist">
                                                    <li name="plot_effect" role="presentation" class="active"><a href="#tab_effect" aria-controls="tab_effect" role="tab" data-toggle="tab">Effect</a></li>
                                                    <li name="plot_mediation" role="presentation"><a href="#tab_mediation" aria-controls="tab_mediation" role="tab" data-toggle="tab">Mediation</a></li>
                                                </ul>

                                                <!-- Tab panes -->
                                                <div class="tab-content">
                                                    <div role="tabpanel" class="tab-pane active" id="tab_effect">
                                                        <div class="row row-spacer"></div>
                                                        <div class="row">
                                                            <div class="col-sm-offset-1 col-sm-11" id="plot_effect_settings">
                                                                <strong>Settings</strong>
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="col-sm-offset-1 col-sm-11">
                                                                 Best Linear Unbiased Predictors (BLUPs)
                                                                <input id="mediate_blup" name="mediate_blup" type="checkbox" data-size="mini">
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="col-sm-12">
                                                                <div id="plot_effect_wait">
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="col-sm-12">
                                                                <div id="plot_effect">
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div role="tabpanel" class="tab-pane" id="tab_mediation">
                                                        <div class="row">
                                                            <div class="col-sm-12">
                                                                <div id="plot_mediation_wait"></div>
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="col-sm-12">
                                                                <div id="plot_mediation" style="width:100%; height:100%"></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!--

                        END PLOTS ON RIGHT SIDE

                        //-->
                    </div>
                </div>

            </div>

        </div>
    </div>
    <!-- /.container -->


    <script src="{{request.URL_BASE}}/static/js/jquery-2.0.3.min.js"></script>
    <script src="{{request.URL_BASE}}/static/bootstrap-3.3.5/js/bootstrap.min.js"></script>
    <script src="http://churchill-lab.jax.org/whoz/api/js/whoz_api.js"></script>
    <script src="{{request.URL_BASE}}/static/DataTables-1.10.12/media/js/jquery.dataTables.min.js"></script>
    <script src="{{request.URL_BASE}}/static/DataTables-1.10.12/media/js/dataTables.bootstrap.min.js"></script>
    <script src="{{request.URL_BASE}}/static/js/plotly-latest.js"></script>

    <!--
    If using d3.v4.js, queue is incluced, however d3.v4.js breaks factexpviewer.js
    //-->

    <script src="{{request.URL_BASE}}/static/js/d3.v3.js"></script>
    <script src="{{request.URL_BASE}}/static/js/d3-queue.min.js"></script>
    <script src="{{request.URL_BASE}}/static/bootstrap-switch/js/bootstrap-switch.min.js"></script>
    <script src="{{request.URL_BASE}}/static/bootstrap-select/js/bootstrap-select.min.js"></script>
    <script src="{{request.URL_BASE}}/static/bootstrap-notify-3.1.3/bootstrap-notify.min.js"></script>
    <script src="{{request.URL_BASE}}/static/bootstrap-multiselect/js/bootstrap-multiselect.js"></script>
    <script src="{{request.URL_BASE}}/static/js/seedrandom.js"></script>
    <script src="{{request.URL_BASE}}/static/js/factexpviewer.js"></script>

    <script>
    <!--
    // GLOBALS AND VARIABLES
    var _G = {};

    // information on chromosomes
    _G.chromosomes = {'idx': [], 'nameToIdx': {}, 'totalLength':-1};

    // gene ids
    /*
       gene_ids: {
          "ENSMUSG00000000001": {id:"ENSMUSG00000000001"},
          "ENSMUSG00000000008": {id:"ENSMUSG00000000008"}
       }
    */
    _G.genes = {gene_ids:{}};

    // protein ids and gene ids
    /*
       gene_ids: {
          "ENSMUSG00000000001": {
              id:"ENSMUSG00000000001",
              protein_ids:["ENSMUSP00000000001"]
          },
          "ENSMUSG00000000002": {
              id:"ENSMUSG00000000002",
              protein_ids:["ENSMUSP00000000049","ENSMUSP00000000050"]
          }
       },
       proteins_ids : [
           "ENSMUSP00000000001",
           "ENSMUSP00000000049",
           "ENSMUSP00000000090"
       ]
    */
    _G.proteins = {gene_ids:{}, proteins_ids: []};

    // gene id to search result map
    _G.searchResults = null;

    // APIS
    _G.api_root = "http://127.0.0.1:18001";
    _G.url_proxy = "//127.0.0.1:19890/proxy/";
    _G.url_chromosomes = "/static/chromosomes.mm.38.NO_Y.json";

    _G.url_apis = {
        options: _G.api_root + '/options',
        ids: _G.api_root + '/ids',
        lod: _G.api_root + '/lodscan',
        mediate: _G.api_root + '/mediate',
        effect: _G.api_root + '/foundercoefs',
        expression: _G.api_root + '/expression',
    };

    // PLOTS

    _G.plots = {
        lod: {
            el: 'plot_lod',
            el_wait: 'plot_lod_wait',
            obj: null,
            clear: function() {
                $("#plot_lod").html('');
            }
        },
        mediation: {
            el: 'plot_mediation',
            el_wait: 'plot_mediation_wait',
            obj: null,
            clear: function() {
                $("#plot_mediation").html('');
            }
        },
        effect: {
            el: 'plot_effect',
            el_wait: 'plot_effect_wait',
            obj: null,
            clear: function() {
                $("#plot_effect").html('');
            }
        },
        profile: {
            el: 'plot_profile',
            el_wait: null,
            obj: null,
            clear: function() {
                $("#fact-svg-panel").html('<svg id="fact-svg-chart" width="100%" height="400px"></svg>');
            }
        }
    };

    _G.current_gene_id = null;
    _G.current_protein_id = null;
    _G.current_level = "mrna";
    _G.cond = "default";

    var WHOZ = null;

    function formatMbp(Mbp) {
        return Number(Mbp).toFixed(2);
    }

    function clearAllPlots() {
        for (p in _G.plots) {
            _G.plots[p].clear();
        }

        if (!$("#plot_lod_event_panel").hasClass('hidden')) {
            $("#plot_lod_event_panel").addClass('hidden');
        }

        $("#current_gene_information").html("");
    }

    function findGene() {
        $("#btnGo").button('loading');
        var searchTerm = $('#searchTerm').val().trim().toUpperCase();
        if (searchTerm.length == 0) {
            $('#searchTerm').focus();
            $("#btnGo").button('reset');
            return;
        }

        console.log("Calling api");
        WHOZ.search(searchTerm, {species: 'Mm'}, searchCallback);
    }


    function searchCallback() {
        if (WHOZ.results == null) {
            $('#searchResultsStatus').html("<br><span class='text-danger'>Error searching.</span>");
            $('#searchResults').html("");
            return;
        }

        var results = WHOZ.results;

        var tbl = '<table id="searchTable" class="compact table table-striped table-bordered" cellspacing="0" width="100%"></table>';
        $('#searchResults').html(tbl);

        var searchResults = {};
        for (var d in results) {
            var _match = results[d];
            searchResults[_match.ensembl_gene_id] = _match;
        }

        //console.log(results);

        var _columns = [];

        if (_G.current_level === "mrna") {
            _columns.push({
                title:'ID',
                data:"ensembl_gene_id",
                render: function(data, type, row, meta) {
                    if (type === 'display') {
                        if (_G.genes.gene_ids[data]) {
                            return '<small><span id="matchInfo" gene_id="' + data + '" class="glyphicon glyphicon-info-sign"></span> <a href="#" gene_id="' + data + '">' + data + '</a></small>';
                        }else {
                            return '<small><span id="matchInfo" gene_id="' + data + '" class="glyphicon glyphicon-info-sign"></span> ' + data + '</small>';
                        }

                    } else {
                        return data;
                    }

                }
            });
        } else {
            _columns.push({
                title:'ID',
                data:"ensembl_gene_id",
                render: function(data, type, row, meta) {
                    if (type === 'display') {
                        //console.log('data=', data);
                        var ps = []
                        if (_G.proteins.gene_ids[data]) {
                            var ret = '<small><span id="matchInfo" gene_id="' + data + '" class="glyphicon glyphicon-info-sign"></span> ' + data;
                            ret += '<br><div style="padding-left: 20px;">';
                            ret += '<em>';

                            for (p in _G.proteins.gene_ids[data].protein_ids) {
                                ps.push('<a href="#" gene_id="' + data + '" protein_id="' + _G.proteins.gene_ids[data].protein_ids[p] + '">' + _G.proteins.gene_ids[data].protein_ids[p] + '</a>');
                            }

                            return  ret +  ps.join('<br>') + "</em></div></small>";

                        }else {
                            return '<small><span id="matchInfo" gene_id="' + data + '" class="glyphicon glyphicon-info-sign"></span> ' + data +'</small>';
                        }
                    } else {
                        return data;
                    }

                }
            });
        }

        _columns.push({
                title:'Symbol',
                data:"symbol"
            }
        );

        $("#searchTable").DataTable({
            data: results,
            paging: false,
            order: [],   // prevent automatic ordering
            scrollY: 400,
            searching: false,
            lengthChange: false,
            scrollCollapse: true,
            columns: _columns
        });

        if (results.length == 1) {
           $('#searchTable_info').html(results.length.toLocaleString() + " result");
        } else {
           $('#searchTable_info').html(results.length.toLocaleString() + " results");
        }


        $("#searchTable a").click(function (e) {
            e.preventDefault();

            var _this = $(this);

            _G.current_gene_id = _this.attr('gene_id');
            _G.current_protein_id = _this.attr('protein_id');

            clearAllPlots();
            displayCurrentInformation();
            generateLODPlot(_G.current_gene_id, _G.current_protein_id);

            return false;
        });


        to = setTimeout(function () {
            $("[id='matchInfo']").each(function () {
                var that = $(this);

                $(this).popover({
                    placement: 'right',
                    html: true,
                    trigger: 'hover',
                    container: 'body',
                    template:'<div class="popover container my-custom-class" role="tooltip"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>',
                    content: function () {
                        //console.log('that=',that);
                        //console.log('that[0].getAttribute("feature_id")=', that[0].getAttribute("feature_id"));
                        var d = searchResults[that[0].getAttribute("gene_id")];
                        var h = '<table class="table table-condensed">';
                        h += '<tr><td><strong>Symbol</strong> </td><td>' + d['symbol'] + '</td></tr>';
                        h += '<tr><td><strong>Location</strong> </td><td>' + d['chromosome'] + ':' + d['position_start'] + '-' + d['position_end'] + '</td></tr>';
                        h += '<tr><td><strong>Name</strong> </td><td>' + d['name'] + '</td></tr>';
                        h += '<tr><td><strong>Synonyms</strong> </td><td>';

                        var s = d['synonyms'];
                        if (s) {
                            if (s.length > 5) {
                                var s2 = s.slice(1, 6);
                                h += s2.join("<br>");
                                h += "<br><i>(" + (s.length - s2.length) + " more synonyms)</i>";
                            } else {
                                h += s.join("<br>");
                            }
                        }
                        h += '</td></tr>';
                        h += '<tr><td><strong>Match Reason</strong> </td><td>' + d['match_reason'] + '</td></tr>';
                        h += '<tr><td><strong>Match Value</strong> </td><td>' + d['match_value'] + '</td></tr>';
                        h += '</table>';

                        return h;
                    }
                });
            });
        });

        _G.searchResults = searchResults;
        $("#btnGo").button('reset');

        if (Object.keys(_G.searchResults).length == 1) {
            $("#searchTable a")[0].click();
        }
    }


    function plotLOD(lods, gene_id, protein_id) {
        var dataByChrom = {};

        // current {"id":"1_12097218","chr":"1","pos":12097218,"pheno1":1.9185}
        // old     {rs: "rs4222106", chromosome: 19, position: 57.10794, lod: 0.17895197357}

        console.log('lods=', lods);

        var max_element = lods[0];

        $.each(lods, function(index, element) {
            //console.log('element=', element);
            var chr = _G.chromosomes.idx[_G.chromosomes.nameToIdx[element.chr]];
            var x = chr.start + (element.pos);
            var y = element.pheno1;

            if (element.pheno1 > max_element.pheno1) {
                max_element = element;
            }


            // chr = {chromosome: "Y", end:2725521390, length: 91744698,
            //        mid: 2679649040, name: "Y", order: 21, start: 2633776692 }
            if (!(chr.chromosome in dataByChrom)) {
                dataByChrom[chr.chromosome] = {'x':[], 'y':[], 'text':[], 'id':[]};
            }
            //console.log(dataByChrom[chr.chromosome]['x']);
            dataByChrom[chr.chromosome]['x'].push(x);
            dataByChrom[chr.chromosome]['y'].push(y);
            dataByChrom[chr.chromosome]['text'].push(element.pheno1+'');
            dataByChrom[chr.chromosome]['id'].push(element.id);
        });


    _G.lod_traces = {};

        var traces = [];

        $.each(dataByChrom, function(key, value) {
            //console.log(key);
            //console.log(value);
            var trace = {
                type: 'scatter',
                x: value['x'],
                y: value['y'],
                text: value['id'],
                //name: value['text'],
                name: key,
                hoverinfo:'text',
                mode: 'lines',
                opacity: 100.0,
                line: {
                    color: 'rgb(0,0,0)',
                    width: 1
                }

            };

            _G.lod_traces[key] = trace;
            traces.push(trace);
        });


        var axis_tick_vals = [];
        var axis_tick_text = [];

        // rectangles to display
        var chrom_shapes = [];
        var data_chr = {};

        // lines
        {% if CONF.PLOT_LOD_LINES %}
        var line_vals = [
            {% for l in CONF.PLOT_LOD_LINES %}
            {'val':{{l.val}}, 'color':'{{l.color}}', 'text':'{{l.text }}' },
            {% endfor %}
        ];

        var line_annotations = [];

        for (var l in line_vals) {
            chrom_shapes.push({
                type: 'line',
                // x-reference is assigned to the x-values
                xref: 'paper',
                // y-reference is assigned to the y-values
                //yref: 'paper',
                x0: 0,
                y0: line_vals[l].val,
                x1: 1,
                y1: line_vals[l].val,
                line: {
                    color: line_vals[l].color,
                    width: 1.5
                },
                layer: 'above',
            });

            line_annotations.push({
                x: 1,
                y: line_vals[l].val,
                xref: 'paper',
                yref: 'y',
                text: line_vals[l].text,
                xanchor: 'left',
                yanchor: 'middle',
                showarrow: false,
            });
        }
        {% endif %}


        $.each(_G.chromosomes.idx, function(index, element) {

            axis_tick_vals.push(element.mid);
            axis_tick_text.push(element.name);

            data_chr[element.name] = {};
            data_chr[element.name].data = [];

            var fill_color = '#ffffff';
            if ((index % 2) == 0) {
                fill_color = '#222222';
            }
            var s =  {
                type: 'rect',
                // x-reference is assigned to the x-values
                xref: 'x',
                // y-reference is assigned to the paper space (0 to 1)
                yref: 'paper',
                x0: element.start,
                y0: 0,
                x1: element.end,
                y1: 1,
                fillcolor: fill_color,
                opacity: 0.2,
                line: {
                    width: 0.0
                },
            };

            chrom_shapes.push(s);
        });


        //console.log(JSON.stringify(chrom_shapes));

        var data = [];

        var _title = '';
        if (_G.current_level === 'mrna') {
            _title = gene_id + " (" + _G.searchResults[gene_id].symbol + ")";
        } else {
            _title = protein_id + " (" + _G.searchResults[gene_id].symbol + ")";

        }

        var layout = {
            annotations: line_annotations,
            xaxis: {
                title: _title,
                showgrid: false,
                zeroline: true,
                showline: true,
                mirror: 'ticks',
                gridcolor: '#bdbdbd',
                gridwidth: 2,
                zerolinecolor: '#969696',
                zerolinewidth: 4,
                linecolor: '#636363',
                linewidth: 1,
                side: 'top',
                autorange: false,
                tickvals: axis_tick_vals,
                ticktext: axis_tick_text,
                range: [0, _G.chromosomes.totalLength],
                tickfont: {
                    color: 'rgb(0,0,0)',
                    size:12
                },
                tickangle: 0,
                //fixedrange: true,

            },
            yaxis: {
                title: '{{CONF.PLOT_LOD_XAXIS_TEXT}}',
                showgrid: false,
                zeroline: false,
                showline: true,
                mirror: 'all',
                gridcolor: '#bdbdbd',
                gridwidth: 2,
                zerolinecolor: '#969696',
                zerolinewidth: 1,
                linecolor: '#636363',
                linewidth: 1,
                range: [-2,max_element.pheno1+5],
                tickwidth:2,
                tickmode:'array',
                tickangle: 0,
                //fixedrange: true,

            },

            showlegend: false,
            shapes: chrom_shapes,
            hovermode: 'closest',

        };



        console.log(traces[0]);

        var testButton = {
            name: 'zoom2daaa',
            title: 'woooohoooooo',
            attr: 'dragmode',
            val: 'zoom',
            //icon: Icons.zoombox,
            click: function(a,b,c) {
                console.log('a=',a);
                console.log('b=',b);
                console.log('c=',c);
            },
        };


        //console.log(JSON.stringify(traces[0]));
        //console.log(JSON.stringify(layout));

        _G.plots.lod.plotly = Plotly.newPlot(_G.plots.lod.el,
            traces,
            layout,
            {
                displayModeBar: true, // true to always display top bar, false to hide
                scrollZoom: false,    // true to allow zoom with mouse wheel, false to prevent
                displaylogo: false,   // true to display Plotly logo, false to hide
                showLink: false,      // true to show edit on Plotly website, false to hide
                modeBarButtonsToRemove: ['sendDataToCloud', 'autoScale2d', 'hoverCompareCartesian', 'hoverClosestCartesian'],
                //modeBarButtonsToAdd: [testButton],
                logging:true,
            }
        );

        Plotly.setPlotConfig({logging:true});

        var myPlot = document.getElementById(_G.plots.lod.el);

        myPlot.on('plotly_click', function(data){

            console.log('plotly_click=', data);
            var marker = '';
            var pts = '';
            var chromosome = '';
            for(var i=0; i < data.points.length; i++){
                pts = 'x = '+data.points[i].x +'\ny = '+
                    data.points[i].y.toPrecision(4) + '\n\n';



                console.log(data.points[i].pointNumber);
                console.log(data.points[i].data.text[data.points[i].pointNumber]);

                marker = data.points[i].data.text[data.points[i].pointNumber];
                chromosome = data.points[i].data.name;


            }


            console.log('Closest point clicked:\n\n'+pts);
            //console.log(_G.current_id, ensembl_id);

            var plot=$("#secondaryPlotTabs").find('.active').attr("name");

            console.log('plot=',plot);

            if (plot === "plot_mediation") {
                generateMediationPlot(_G.current_gene_id, marker);
            } else if (plot === "plot_effect") {
                generateEffectPlot(_G.current_gene_id, chromosome);
            } else {
                alert('oops');
            }


            //generateEffectPlot




        });


        myPlot.on('plotly_hover', function(data){
            console.log('plotly_hover=', data);

            var infotext = data.points.map(function(d){
              return (d.data.name+': x= '+d.x+', y= '+d.y.toPrecision(3));
            });

        }).on('plotly_unhover', function(data){
            //hoverInfo.innerHTML = '';
        });

        $("#" + _G.plots.lod.el_wait).html("");
        $("#plot_lod_event_panel").removeClass('hidden'); // to show
    }

    function plotEffect(effect) {
        var strainInfo = {};
        strainInfo["A"] = {'color':"#F0F000",'name':"A/J",'data':[]};
        strainInfo["B"] = {'color':"#808080",'name':"C57BL/6J",'data':[]};
        strainInfo["C"] = {'color':"#F08080",'name':"129S1/SvImJ",'data':[]};
        strainInfo["D"] = {'color':"#1010F0",'name':"NOD/ShiLtJ",'data':[]};
        strainInfo["E"] = {'color':"#00A0F0",'name':"NZO/H1LtJ",'data':[]};
        strainInfo["F"] = {'color':"#00A000",'name':"CAST/EiJ",'data':[]};
        strainInfo["G"] = {'color':"#F00000",'name':"PWK/PhJ",'data':[]};
        strainInfo["H"] = {'color':"#9000E0",'name':"WSB/EiJ",'data':[]};
        var x = [];
        var ids = [];

        var chr = null;

        var min_pos = Infinity;
        var max_pos = -Infinity;

        $.each(effect.data, function(index, element) {
            //console.log('element=', element);

            //{"A":-0.1224,..."H":1.45,"chr":"4","id":"4_156339889","pos":156.3399}

            strainInfo['A']['data'].push(element.A);
            strainInfo['B']['data'].push(element.B);
            strainInfo['C']['data'].push(element.C);
            strainInfo['D']['data'].push(element.D);
            strainInfo['E']['data'].push(element.E);
            strainInfo['F']['data'].push(element.F);
            strainInfo['G']['data'].push(element.G);
            strainInfo['H']['data'].push(element.H);

            var _pos = element.pos * 1000000;

            x.push(_pos);
            ids.push(element.id);
            chr = element.chr;

            if (max_pos < _pos) {
                max_pos = _pos;
            }
            if (min_pos > _pos) {
                min_pos = _pos;
            }
        });

        console.log('MINPOS========',min_pos);
        console.log('MAXPOS========',max_pos);
        console.log('CHR========',chr);
        var c = _G.chromosomes.idx[_G.chromosomes.nameToIdx[chr]];
        console.log(c);

        var traces = [];

        $.each(strainInfo, function(key, value) {
            traces.push({
                  type: 'scatter',
                  x: x,
                  y: value['data'],
                  text: ids,
                  //name: value['text'],
                  name: value['name'],
                  hoverinfo:'text',
                  mode: 'lines',
                  opacity: 100.0,
                  line: {
                    color: value['color'],
                    width: 1.5
                  }

            });
        });

        var _title = _G.current_gene_id;

        if (_G.current_level === 'protein') {
            _title =  _G.current_protein_id;
        }

        // TODO: add range


        var layout = {
            title: _title,
            xaxis: {
                //title: _title,
                //showgrid: false,
                zeroline: true,
                showline: true,
                mirror: 'all',
                gridcolor: '#bdbdbd',
                gridwidth: 2,
                zerolinecolor: '#969696',
                zerolinewidth: 1,
                linecolor: '#636363',
                linewidth: 1,
                //side: 'top',
                //autorange: false,


                // TODO: working on tick values for x axis


                tickvals: [0, 10000000, 20000000],
                ticktext: ["0", "10000000", "20000000"],
                //range: [0, _G.chromosomes.totalLength],
                tickfont: {
                    color: 'rgb(0,0,0)',
                    size:12
                },
                tickwidth:2,
                tickangle: 0,
                fixedrange: true,

            },
            yaxis: {
                title: 'Founder Effects',
                showgrid: false,
                zeroline: false,
                showline: true,
                mirror: 'all',
                gridcolor: '#bdbdbd',
                gridwidth: 2,
                zerolinecolor: '#969696',
                zerolinewidth: 1,
                linecolor: '#636363',
                linewidth: 1,
                //autorange: true,
                //range: [-2,22],
                fixedrange: true,
                tickwidth:2,
                tickmode:'array',
                tickangle: 0,

            },

            //shapes: chrom_shapes,
            hovermode: 'closest',

        };

        console.log(traces);


        // ADD BOTTOM TO PLOT
        var temp_trace = _G.lod_traces[_G.current_chromosome];

        console.log('temp_trace=', temp_trace);

        var bottom_trace = {
                  type: 'scatter',
                  x: temp_trace['x'],
                  y: temp_trace['y'],
                  title: 'LOD',
                  mode: 'lines',
                  opacity: 100.0,
                  line: {
                      width: 1.5,
                      color: 'rgb(0,0,0)',
                  },
                  xaxis: 'x2',
                  yaxis: 'y2',
            showlegend: false,
            hoverinfo:'text',


            };

        console.log('bottom_trace=', bottom_trace);

        layout['yaxis']['domain'] = [.3, 1];
        layout['yaxis2'] = {domain: [0, .3], fixedrange:true, title: 'LOD'};

        layout['xaxis2'] = {anchor:'y2', fixedrange:true, };
            //showlegend: false,

        traces.push(bottom_trace);



        _G.plots.effect.plotly = Plotly.newPlot(_G.plots.effect.el,
            traces,
            layout,
            {

                displayModeBar: true, // true to always display top bar, false to hide
                scrollZoom: false,    // true to allow zoom with mouse wheel, false to prevent
                displaylogo: false,   // true to display Plotly logo, false to hide
                showLink: false,      // true to show edit on Plotly website, false to hide
                modeBarButtonsToRemove: ['sendDataToCloud', 'autoScale2d', 'hoverCompareCartesian', 'hoverClosestCartesian'],


                //modeBarButtonsToAdd: [testButton],
            }
        );

        $("#" + _G.plots.effect.el_wait).html("");

    }



    function plotMediation(data) {
        var x_coord = [];
        var y_coord = [];
        var text = [];

        // probably easier d3 function but just looping for now
        //'LOD': 3.4188, 'chr' : "11", id: "ENSMUSG00000099291", pos:87448734, symbol: "ACEA_U3"

        $.each(data, function(index, element) {
            //console.log('element=', element);
            //if (element.chr in Object.keys(_G.chromosomes.nameToIdx)) {
            if (element.chr in _G.chromosomes.nameToIdx) {

                var chr = _G.chromosomes.idx[_G.chromosomes.nameToIdx[element.chr]];
                var x = chr.start + (element.pos);
                var y = element.LOD;

                /*
                if (element.chr === 'X') {
                    console.log(chr, x, y);
                }
                */

                x_coord.push(x);
                y_coord.push(y);
                text.push(element.symbol);
            } else {
                //console.log(element);
            }
        });

        var traces = [];
        traces.push({
            x: x_coord,
            y: y_coord,
            text: text,
            mode: 'markers',
            type: 'scatter',
            hoverinfo: 'text',
            marker: {
                size: 5,
                color: 'rgb(255,255,255)',
                line: {
                    color: 'rgb(139,26,26)',
                    width: 1
                }
            }
        });

        var axis_tick_vals = [];
        var axis_tick_text = [];

        // rectangles to display
        var chrom_shapes = [];
        var data_chr = {};

        $.each(_G.chromosomes.idx, function(index, element) {

            axis_tick_vals.push(element.mid);
            axis_tick_text.push(element.name);

            data_chr[element.name] = {};
            data_chr[element.name].data = [];

            var fill_color = '#ffffff';
            if ((index % 2) == 0) {
                fill_color = '#222222';
            }
            var s =  {
                type: 'rect',
                // x-reference is assigned to the x-values
                xref: 'x',
                // y-reference is assigned to the paper space (0 to 1)
                yref: 'paper',
                x0: element.start,
                y0: 0,
                x1: element.end,
                y1: 1,
                fillcolor: fill_color,
                opacity: 0.2,
                line: {
                    width: 0.0
                },
            };

            chrom_shapes.push(s);
        });


        //console.log(JSON.stringify(chrom_shapes));

        var data = [];


        var _title = _G.current_gene_id;

        if (_G.current_level === 'protein') {
            _title =  _G.current_protein_id;
        }

        var layout = {
            title: _title,
            xaxis: {
                //title: ensembl_id + " (" + _G.searchResults[ensembl_id].symbol + ")",
                showgrid: false,
                zeroline: true,
                showline: true,
                mirror: 'ticks',
                gridcolor: '#bdbdbd',
                gridwidth: 2,
                zerolinecolor: '#969696',
                zerolinewidth: 4,
                linecolor: '#636363',
                linewidth: 1,
                side: 'top',
                autorange: false,
                tickvals: axis_tick_vals,
                ticktext: axis_tick_text,
                range: [0, _G.chromosomes.totalLength],
                tickfont: {
                    color: 'rgb(0,0,0)',
                    size:12
                },
                tickangle: 0,

            },
            yaxis: {
                title: 'lod',
                showgrid: false,
                zeroline: false,
                showline: true,
                mirror: 'all',
                gridcolor: '#bdbdbd',
                gridwidth: 2,
                zerolinecolor: '#969696',
                zerolinewidth: 1,
                linecolor: '#636363',
                linewidth: 1,
                //range: [-2,22],
                tickwidth:2,
                tickmode:'array',
                tickangle: 0,

            },

            showlegend: false,
            shapes: chrom_shapes,
            hovermode: 'closest',

        };

        _G.plots.mediate.plotly = Plotly.newPlot(_G.plots.mediate.el,
            traces,
            layout,
            {
                scrollZoom: false,
                displaylogo: false,
                showLink: false,
                modeBarButtonsToRemove: ['sendDataToCloud', 'autoScale2d', 'hoverCompareCartesian', 'hoverClosestCartesian'],
                logging: 5,
            }
        );

        $("#" + _G.plots.mediate.el_wait).html("");
    }

    function plotProfile_new(ensembl_gene_id, ensembl_protein_id, profile_data, profiles) {


        var profile_info = {};

        $.each(profile_data.data_types, function(key, value) {

            profile_info[key] = {levels: value, name: key, kind: "factor", values: []};
        });

        console.log('profile_info=',profile_info);


        var samples = [];
        var expression = [];

        $.each(profile_data.data, function(index, element) {
            samples.push(element.mouse_id);

            $.each(profile_data.data_types, function(key, value) {
                profile_info[key].values.push(element[key]+"");
            });

            expression.push(element.expression);
        });


        var xvar = [];
        $.each(profiles, function(index, element) {
            xvar.push(profile_info[element]);
        });


        var yname = ensembl_gene_id;
        if (_G.current_level == "mrna") {
            yname = ensembl_gene_id;
        } else {
            yname = ensembl_protein_id;
        }



        var yvar = [];
        yvar.push({
            kind: "number",
            name: yname,
            values: expression,
        });




        var plotParams = {
            //title: ensembl_id,
            sampleCount: samples.length,
            xAxis: {
                jitterPx: 25,
                min: null,
                max: null,
                variables: xvar,
                tickLabelRotationDeg: -45
            },
            yAxis: {
                min: null,
                max: null,
                variables: yvar,
                whiskers: {
                    units: "stderr",
                    dist: 1
                }
            }
        };

        _G.fact = {};

        _G.fact.plotParams = plotParams;

        _G.fact.samples = samples;

        // using this so plots have same jitter

        Math.seedrandom('whozapi');


        _G.fact.jsobject = new FactExpPlot({
            svg: d3.select("#fact-svg-chart"),
            pointSizePx: 5,
        });

        // not using mouseOverPoint because it wasn't showing tooltip on initial hover
        /*
        _G.fact.jsobject.mouseOverPoint = function(a, b) {
            console.log(a, b);
            console.log($(b));
            $(b).popover({
                placement: 'auto',
                html: true,
                trigger: 'hover',
                container: 'body',
                content: function () {
                    return _G.fact.samples[a];
                }
            });
        }*/


        /**
         * Here we do some styling.  This is hard coded right now.
         */
         _G.fact.jsobject.postProcessPoint = function(sampleIndex, d3Node) {
             //console.log(sampleIndex, d3Node);
             //console.log(profile_info['sex'].values[sampleIndex]);
                    d3Node.classed("female", profile_info['sex'].values[sampleIndex] == "F");
                    d3Node.classed("male", profile_info['sex'].values[sampleIndex] == "M");

             if (profile_info['age'].values[sampleIndex] == "6") {
                 _G.fact.jsobject.setPointShape(d3Node, DataPointShape.SQUARE);
             } else if (profile_info['age'].values[sampleIndex] == "12") {
                 _G.fact.jsobject.setPointShape(d3Node, DataPointShape.DIAMOND);
             } else if (profile_info['age'].values[sampleIndex] == "12") {
                 _G.fact.jsobject.setPointShape(d3Node, DataPointShape.STAR);
             }


                };

        _G.fact.jsobject.renderPlot(plotParams);


        $("#points-group use").each(function () {
            var that = $(this);
            var sample_index = parseInt($(this).attr('sample-index'));
            $(this).popover({
                placement: 'left',
                html: true,
                trigger: 'hover',
                container: 'body',
                content: function () {
                    return _G.fact.samples[sample_index];
                }
            });
        });




    }




    /**
     * Download LOD scan data from the server
     */
    function downloadLODData(gene_id, protein_id, callback) {
        var _url = _G.url_apis.lod + "/" + _G.current_level;

        if (_G.current_level == "mrna") {
            _url += "?id=" + gene_id;
        } else {
            _url += "?id=" + protein_id;
        }

        if (_G.cond === "local") {
            _url += "&regress_local=TRUE";
        }

        var cache_url = _G.url_proxy + _url;
        console.log("AJAX request to: ", cache_url);

        $.ajax({
            url: cache_url,
            method: "GET"
        }).done(function(data, textStatus, jqXHR) {
            console.log("lod download success", data);
            callback(null, data);
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.log("lod download failure");
            callback(errorThrown, null);
        });
    }


    function downloadMediationData(ensembl_id, marker_id, callback) {
        var _url = _G.url_apis.mediate + "?id=" + ensembl_id + "&" + "mid=" + marker_id;
        var cache_url = _G.url_proxy + _url;
        console.log("AJAX request to: ", cache_url);

        $.ajax({
            url: cache_url,
            method: "GET"
        }).done(function(data, textStatus, jqXHR) {
            console.log("mediate download success", data);
            callback(null, data);
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.log("mediate download failure");
            callback(errorThrown, null);
        });

    }

    function downloadEffectData(ensembl_id, chromosome, callback) {
        var _url = _G.url_apis.effect + "?id=" + ensembl_id + "&" + "chr=" + chromosome;

        if ($("#mediate_blup").is(':checked')) {
            _url += '&blup=TRUE';
        }

        if (_G.cond === "local") {
            _url += "&regress_local=TRUE";
        }

        var cache_url = _G.url_proxy + _url;
        console.log("AJAX request to: ", cache_url);

        $.ajax({
            url: _url,
            method: "GET"
        }).done(function(data, textStatus, jqXHR) {
            console.log("foundercoefs download success", data);
            callback(null, data);
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.log("foundercoefs download failure");
            callback(errorThrown, null);
        });

    }

    function downloadProfileData(ensembl_gene_id, ensembl_protein_id, profiles, callback) {
        var _url = _G.url_apis.expression + "/" + _G.current_level;

        if (_G.current_level == "mrna") {
            _url += "?id=" + ensembl_gene_id;
        } else {
            _url += "?id=" + ensembl_protein_id;
        }

        var cache_url = _G.url_proxy + _url;
        console.log("AJAX request to: ", cache_url);

        $.ajax({
            url: cache_url,
            method: "GET"
        }).done(function(data, textStatus, jqXHR) {
            console.log("expression download success", data);
            callback(null, data);
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.log("expression download failure");
            callback(errorThrown, null);
        });
    }



    function generateLODPlot(gene_id, protein_id) {
        _G.current_gene_id = gene_id;
        _G.current_protein_id = protein_id;

        $("#plot_lod").html("");
        $("#plot_lod_wait").html("<img src='http://cgd.jax.org/mda/v1/static/images/ajax-blocks-128x128.gif'/>");
        $("#plot_lod_event_panel").addClass('hidden'); // to hide

        var q = d3.queue()
                .defer(downloadLODData, gene_id, protein_id)
                .await(function(error, data) {
                    console.log('Queue done');
                    //console.log('data=', data);
                    //console.log('error=', error);

                    // TODO: handle errors, if error comes back we won't have data

                    if (error) {
                        var _message = "Unable to download data for <strong><em>";
                        if (_G.current_level == "mrna") {
                            _message += gene_id;
                        } else {
                            _message += protein_id;
                        }
                        _message += "</em></strong>.";

                        displayError("API Server Error", _message);

                        return;
                    }

                    console.log("PLOT LOD");
                    plotLOD(data.data, gene_id, protein_id);
                });
    }

    function generateMediationPlot(ensembl_id, marker_id) {

        $("#plot_mediation").html("");
        $("#plot_mediation_wait").html("<img src='http://cgd.jax.org/mda/v1/static/images/ajax-blocks-128x128.gif'/>");

        var q = d3.queue()
                .defer(downloadMediationData, ensembl_id, marker_id)
                .await(function(error, data) {
                    console.log('Queue done');

                    // TODO: handle errors, if error comes back we won't have data
                    if (error) {
                        var _message = "Unable to download mediation data for <strong><em>";
                        _message += ensembl_id;
                        _message += "</em></strong> on ";
                        _message += "<strong><em>";
                        _message += marker_id;
                        _message += "</em></strong>";

                        displayError("API Server Error", _message);
                        return;
                    }

                    console.log("PLOT MEDIATE");
                    plotMediation(data);


                });
    }

    function generateEffectPlot(ensembl_id, chromosome) {
        _G.current_chromosome = chromosome;
        $("#plot_effect").html("");
        $("#plot_effect_wait").html("<img src='http://cgd.jax.org/mda/v1/static/images/ajax-blocks-128x128.gif'/>");
        console.log(ensembl_id, chromosome);

        var q = d3.queue()
                .defer(downloadEffectData, ensembl_id, chromosome)
                .await(function(error, data) {
                    console.log('Queue done');
                    console.log('data=', data);

                    // TODO: handle errors, if error comes back we won't have data
                    if (error) {
                        var _message = "Unable to download mediation data for <strong><em>";
                        _message += ensembl_id;
                        _message += "</em></strong> on chromosome ";
                        _message += "<strong><em>";
                        _message += chromosome;
                        _message += "</em></strong>";

                        displayError("API Server Error", _message);
                        return;
                    }

                    console.log("PLOT EFFECT")
                    plotEffect(data);


                });
    }

    function generateProfilePlot(ensembl_gene_id, ensembl_protein_id, profiles) {
        $("#plot_profile").html("");
        $("#plot_profile_wait").html("<img src='http://cgd.jax.org/mda/v1/static/images/ajax-blocks-128x128.gif'/>");

        console.log("Generating profile plot", ensembl_gene_id, ensembl_protein_id, profiles);
        var q = d3.queue()
                .defer(downloadProfileData, ensembl_gene_id, ensembl_protein_id, profiles)
                .await(function(error, data) {
                    console.log('Queue done');
                    console.log('data=', data);

                    // TODO: handle errors, if error comes back we won't have data
                    if (error) {
                        var _message = "Unable to download profile data for <strong><em>";
                        _message += ensembl_id;
                        _message += "</em></strong>.";

                        displayError("API Server Error", _message);
                        return;
                    }

                    console.log("PLOT PROFILE")
                    plotProfile_new(ensembl_gene_id, ensembl_protein_id, data, profiles);


                });
    }

    function loadOptions(callback) {
        /*
        From d3.js documentation:

         When a task completes, it must call the provided callback.

         The first argument to the callback should be null if the task is successfull,
         or the error if the task failed.

         The optional second argument to the callback is the return value of the task.
         (To return multiple values from a single callback, wrap the results in an object or array.)
        */
        var _url = _G.url_proxy + _G.url_apis.options;
        $.ajax({
            url: _url,
            method: "GET"
        }).done(function(data, textStatus, jqXHR) {
            console.log("options download success");
            console.log("options=", data);
            callback(null, data);
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.log("options download failure");
            callback(errorThrown, null);
        });
    }

    function loadChromsomes(callback) {
        var _url = _G.url_chromosomes;
        console.log("Downloading chromosomes: ", _url);

        $.ajax({
            url: _url,
            method: "GET"
        }).done(function(data, textStatus, jqXHR) {
            console.log("chromosome download success");
            console.log('chromosome data=',data);
            callback(null, data);
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.log("chromosome download failure");
            console.log("genes download failure");
            console.log('jqXHR=', jqXHR);
            console.log('textStatus=', textStatus);
            console.log('errorThrown=', errorThrown);
            displayError("Server Error", "Unable to download chromosome information");
            callback(errorThrown, null);
        });
    }

    function loadGenes(callback) {
        var _url = _G.url_proxy + _G.url_apis.ids + "?id_type=mrna";
        console.log("Downloading genes: ", _url);

        $.ajax({
            url: _url,
            method: "GET"
        })
        .done(function(data, textStatus, jqXHR) {
            console.log("genes download success", data);
            callback(null, data);
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.log("genes download failure");
            console.log('jqXHR=', jqXHR);
            console.log('textStatus=', textStatus);
            console.log('errorThrown=', errorThrown);
            displayError("API Server Error", "Error downloading gene information");
            callback(errorThrown, null);
        });
    }

    function loadProteins(callback) {
        var _url = _G.url_proxy + _G.url_apis.ids + "?id_type=protein";
        console.log("Downloading proteins: ", _url);

        $.ajax({
            url: _url,
            method: "GET"
        })
        .done(function(data, textStatus, jqXHR) {
            console.log("proteins download success");
            callback(null, data);
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.log("proteins download failure");
            console.log('jqXHR=', jqXHR);
            console.log('textStatus=', textStatus);
            console.log('errorThrown=', errorThrown);
            displayError("API Server Error", "Error downloading protein information");
            callback(errorThrown, null);
        });
    }

    function findBootstrapEnvironment() {
        var envs = ["xs", "sm", "md", "lg"];
        var doc = window.document;
        var temp = doc.createElement("div");

        doc.body.appendChild(temp);

        for (var i = envs.length - 1; i >= 0; i--) {
            var env = envs[i];

            temp.className = "hidden-" + env;

            if (temp.offsetParent === null) {
                doc.body.removeChild(temp);
                return env;
            }
        }
        return "";
    }

// Returns a function, that, as long as it continues to be invoked, will not
// be triggered. The function will be called after it stops being called for
// N milliseconds. If `immediate` is passed, trigger the function on the
// leading edge, instead of the trailing.
function debounce(func, wait, immediate) {
	var timeout;
	return function() {
		var context = this, args = arguments;
		var later = function() {
			timeout = null;
			if (!immediate) func.apply(context, args);
		};
		var callNow = immediate && !timeout;
		clearTimeout(timeout);
		timeout = setTimeout(later, wait);
		if (callNow) func.apply(context, args);
	};
};

var debounceLayoutCheck = debounce(function() {
    var bse = findBootstrapEnvironment();
    console.log('bse=',bse);
    if (_G.bootstrapEnv != bse) {
        console.log(_G.bootstrapEnv + ' != ' + bse + ' so redrawing')

        // resize all the graphs
        $.each($(".js-plotly-plot"), function(index, element) {
            Plotly.Plots.resize($("#" + $(element).attr("id"))[0]);
        });
        _G.fact.jsobject.renderPlot(_G.fact.plotParams);

        _G.bootstrapEnv = bse;
    }
}, 250);


function getFactorOrder() {
    var selected = [];
    $('#factor-view-select option:selected').each(function() {
        selected.push([$(this).val(), $(this).attr('order')]);
    });

    selected.sort(function(a, b) {
        return a[1] - b[1];
    });

    var ordered = [];
    for (var i = 0; i < selected.length; i++) {
        ordered.push(selected[i][0]);
    }

    console.log('ordered=',ordered);

    return ordered;

}



    function displayError(_title, _message) {

        $.notify({
            title:"<h5>" + _title + "</h5>",
            message:_message
        }, {
            type: 'danger'
        });

        // make sure all waiting images are no longer
        $.each($("div[id$='wait']"), function(index, element) {
            $(element).html("");
        });
    }

    function displayCurrentInformation() {
        console.log(_G.current_gene_id);
        var _gene = _G.searchResults[_G.current_gene_id];
        console.log(_gene);
        var _startFormat = formatMbp(_gene.position_start/1000000);
        var _endFormat = formatMbp(_gene.position_end/1000000);
        var _mbpDesc = 'Mbp';

        console.log(_startFormat);

        if ( _startFormat < 1) {
            _startFormat = _gene.position_start;
            _endFormat = _gene.position_end;
            _mbpDesc = 'bp';
        }

        var _synonyms = "";

        if (_gene.synonyms) {
            _synonyms = _gene.synonyms.join("<br>");
        }

        var _strand = "forward";

        if (_gene.strand === "-1") {
            _strand = "negative";
        }

        $("#current_gene_information").html("");

        var _html = `<div class="well well-sm">
  		        <a data-toggle="collapse" data-target="#collapseDiv" href="#"><i class="glyphicon glyphicon-plus-sign"></i></a>

                <em>${_gene.symbol}</em> <strong>${_gene.ensembl_gene_id}</strong>,
                located at chromosome ${_gene.chromosome} (${_startFormat} - ${_endFormat} ${_mbpDesc}, ${_strand} strand)
                [
                <a target="_newwin" href="http://www.ensembl.org/id/${_gene.ensembl_gene_id}">Ensembl <small><i class="fa fa-external-link fa-1" aria-hidden="true"></i></small></a>

                <a target="_newwin" href="http://www.informatics.jax.org/marker/${_gene.ensembl_gene_id}">MGI <small><i class="fa fa-external-link fa-1" aria-hidden="true"></i></small></a>
                ]
                <div class="collapse" id="collapseDiv">
                    <div class="row">
                        <div class="col-sm-offset-1 col-sm-11">
                            <table class="whoa">
                                <tr><td valign="top"><strong>ID</strong></td><td>${_gene.ensembl_gene_id||''}</td></tr>
                                <tr><td valign="top"><strong>Symbol</strong></td><td>${_gene.symbol||''}</td></tr>
                                <tr><td valign="top"><strong>Chromosome</strong></td><td>${_gene.chromosome||''}</td></tr>
                                <tr><td valign="top"><strong>Start Position</strong></td><td>${_gene.position_start||''}</td></tr>
                                <tr><td valign="top"><strong>End Position</strong></td><td>${_gene.position_end||''}</td></tr>
                                <tr><td valign="top"><strong>Strand</strong></td><td>${_gene.strand||''}</td></tr>
                                <tr><td valign="top"><strong>Description</strong></td><td>${_gene.description||''}</td></tr>
                                <tr><td valign="top"><strong>Synonyms</strong></td><td>${_synonyms||''}</td></tr>
                            </table>
                        </div>
                    </div>
                </div>`;

        $("#current_gene_information").html(_html);

     $('#collapseDiv').on('shown.bs.collapse', function () {
       $(".glyphicon").removeClass("glyphicon-plus-sign").addClass("glyphicon-minus-sign");
    });

    $('#collapseDiv').on('hidden.bs.collapse', function () {
       $(".glyphicon").removeClass("glyphicon-minus-sign").addClass("glyphicon-plus-sign");
    });

    }

    function init() {
        console.log('initializing...');

        _G.bootstrapEnv = findBootstrapEnvironment();
        window.addEventListener('resize', debounceLayoutCheck);

        $('#searchTerm').keypress(function(e) {
            var code = e.which ? e.which : e.keyCode;
            if (code === 13) {
                $(this).blur();
                $('#btnGo').focus().click();
            }
        });

        $('#btnGo').button().click(function() {
            findGene();
            return false;
        });

        $('#lbl_mrna').on("click", function() {
            _G.current_level = "mrna";

            // TODO: clear lod if PROTEIN and lod mrna
            // what if multiple proteins?
            //return false;
        });

        $('#lbl_protein').on("click", function() {
            _G.current_level = "protein";

            // TODO: clear lod if MRNA and lod protein
            // what if multiple proteins?
            //return false;
        });

        $('#lbl_default').on("click", function() {
            _G.cond = "default";
            if (_G.current_gene_id != null) {
                generateLODPlot(_G.current_gene_id, _G.current_protein_id);
            }

        });

        $('#lbl_local').on("click", function() {
            _G.cond = "local";
            if (_G.current_gene_id != null) {
                generateLODPlot(_G.current_gene_id, _G.current_protein_id);
            }
        });


        _G.orderCount = getFactorOrder().length;




        $('#factor-view-select').multiselect({
            onChange: function(option, checked) {
                if (checked) {
                    _G.orderCount++;
                    $(option).attr('order', _G.orderCount);
                }
                else {
                    $(option).attr('order', '');
                }
            },
            maxHeight: 400,
            dropUp: false,
            buttonWidth: '100%',
            buttonText: function(options) {
                if (options.length === 0) {
                    return 'None selected';
                }
                else {
                    var selected = [];
                    options.each(function() {
                        selected.push([$(this).text(), $(this).attr('order')]);
                    });

                    selected.sort(function(a, b) {
                        return a[1] - b[1];
                    });

                    var text = '';
                    for (var i = 0; i < selected.length; i++) {
                        text += ((i+1) + ": " + selected[i][0] + ', ');
                    }

                    return text.substr(0, text.length -2);
                }
            },
        });


        $("#btnFactPlot").on('click', function() {
            console.log("getFactorOrder=", getFactorOrder());
            generateProfilePlot(_G.current_gene_id, _G.current_protein_id, getFactorOrder());
        });

        console.log('DONE initializing!')
    }

    $().ready(function () {
        init();

        WHOZ = new whoz({
            search_limit: 100,
        });

        console.log('Starting Queue...');
        var q = d3.queue()
            .defer(loadOptions)
            .defer(loadChromsomes)
            .defer(loadGenes)
            .defer(loadProteins)
            .await(function(error, options, chromosomes, genes, proteins) {
                console.log('Queue done');

                // TODO: handle errors, if error comes back we won't have data
                if (error) {
                    console.log('ERROR: ', error);
                    //displayError(error);
                    //throw error;
                    return;
                }

                console.log(options);

                _G.chromosomes = {'idx': chromosomes.chromosomes, 'nameToIdx': {}};

                $.each(chromosomes.chromosomes, function(index, element) {
                    _G.chromosomes['nameToIdx'][element.name] = index;
                });

                _G.chromosomes['totalLength'] = _G.chromosomes.idx[_G.chromosomes.idx.length-1].end;


                console.log(genes);
                var _gene_ids = {};

                $.each(genes.ids, function(index, element) {
                    //console.log(index, element);
                    if (!(element.gene_id in _gene_ids)) {
                        _gene_ids[element.gene_id] = {'id': element.gene_id}
                    }
                });

                _G.genes = {gene_ids:_gene_ids};
                console.log('genes=', _G.genes);

                console.log(proteins);
                _gene_ids = {};
                var _protein_ids = [];

                $.each(proteins.ids, function(index, element) {
                    //console.log(index, element);
                    if (!(element.gene_id in _gene_ids)) {
                        _gene_ids[element.gene_id] = {'id': element.gene_id, 'protein_ids':[]}
                    }
                    _protein_ids.push(element.protein_id)
                    _gene_ids[element.gene_id]['protein_ids'].push(element.protein_id);
                });

                _G.proteins = {gene_ids:_gene_ids, proteins_ids: _protein_ids};
                console.log('proteins=', _G.proteins);


                {% if search_term %}
                    console.log('Finding gene now...');
                    findGene();
                {% endif %}
            });
    });
    //-->
    </script>


</body>
</html>





